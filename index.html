<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASOIAF Builder - 40pts + 3 Free</title>
    <style>
        :root {
            --stark: #2c3e50;
            --bolton: #c0392b;
            --gold: #f1c40f;
            --share: #3498db;
            --bg: #f0f2f5;
            --free-green: #27ae60;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 20px;
            color: #333;
        }

        /* --- HEADER --- */
        header {
            position: sticky;
            top: 0;
            background: white;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            z-index: 100;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .points-box { text-align: left; }
        
        .total-row { display: flex; align-items: baseline; gap: 10px; }
        .total-points { font-size: 2rem; font-weight: 800; color: #333; }
        .free-points { font-size: 1rem; color: var(--free-green); font-weight: bold; background: #eafaf1; padding: 2px 8px; border-radius: 4px; border: 1px solid var(--free-green); }

        .commander-status { font-size: 0.8rem; font-weight: bold; padding: 2px 6px; border-radius: 4px; margin-left: 5px; vertical-align: middle;}
        .status-ok { background: #dff9fb; color: #2ecc71; border: 1px solid #2ecc71; }
        .status-missing { background: #ff797933; color: #e74c3c; border: 1px solid #e74c3c; }

        .header-actions { display: flex; gap: 10px; }
        .btn-action { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s;}
        .btn-reset { background: #e74c3c; }
        .btn-share { background: var(--share); }

        /* --- TABS --- */
        .faction-tabs { display: flex; justify-content: center; margin-bottom: 20px; gap: 10px; }
        .tab-btn {
            padding: 10px 25px; border: 2px solid transparent; background: white;
            cursor: pointer; font-weight: bold; border-radius: 20px; opacity: 0.7; transition: 0.3s;
            text-transform: uppercase;
        }
        .tab-btn.active { opacity: 1; border-color: currentColor; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .stark-btn { color: var(--stark); } .bolton-btn { color: var(--bolton); }

        /* --- LAYOUT --- */
        .container { display: flex; gap: 20px; max-width: 1400px; margin: 0 auto; align-items: flex-start; }
        .column { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .col-store { flex: 6; }
        .col-roster { flex: 4; position: sticky; top: 90px; max-height: 85vh; overflow-y: auto; }

        h3 { border-bottom: 2px solid #eee; padding-bottom: 8px; margin-top: 25px; color: #555; font-size: 0.9rem; text-transform: uppercase; }
        
        .roster-header {
            background: #eee; padding: 8px; font-weight: bold; text-align: center; 
            margin-bottom: 10px; border-radius: 4px; color: #555; font-size: 0.85rem; letter-spacing: 1px;
        }

        /* --- CARDS --- */
        .grid-store { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 12px; }

        .card {
            border: 1px solid #ddd; border-radius: 6px; background: white;
            overflow: hidden; position: relative; transition: transform 0.2s;
            display: flex; flex-direction: column;
        }
        .card:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .card.disabled { opacity: 0.4; filter: grayscale(1); pointer-events: none; }

        .card-img-wrap { width: 100%; height: 80px; overflow: hidden; cursor: zoom-in; }
        .card img { width: 100%; height: 100%; object-fit: cover; object-position: top; transition: transform 0.3s; }
        .card-img-wrap:hover img { transform: scale(1.1); }

        .card-info { padding: 8px; text-align: center; cursor: pointer; flex-grow: 1; background: white;}
        .card-info:hover { background: #f9f9f9; }

        .card-name { font-weight: bold; font-size: 0.8rem; line-height: 1.2; height: 35px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .card-cost { display: inline-block; background: #333; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; margin-top: 5px; }

        .commander-badge {
            position: absolute; top: 0; left: 0; width: 100%; pointer-events: none;
            background: linear-gradient(90deg, #f1c40f, #f39c12);
            color: white; font-size: 0.7rem; font-weight: bold;
            text-align: center; padding: 2px 0; letter-spacing: 1px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 10;
        }

        /* --- ROSTER --- */
        .roster-unit { border: 1px solid #e1e1e1; border-radius: 6px; margin-bottom: 15px; background: white; }
        .unit-header { padding: 10px; display: flex; justify-content: space-between; align-items: center; background: #fdfdfd; border-bottom: 1px solid #f0f0f0; }
        .unit-thumb { width: 45px; height: 45px; border-radius: 4px; object-fit: cover; object-position: top; cursor: zoom-in; border: 1px solid #ccc;}
        
        .att-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 6px 10px; border-bottom: 1px solid #eee; font-size: 0.85rem; background: #f9f9f9;
        }
        .att-row.is-commander { background: #fffcf0; border-left: 3px solid var(--gold); }
        .btn-add { width: 100%; border: 1px dashed #ccc; background: none; padding: 8px; cursor: pointer; color: #777; }
        .btn-add:hover { background: #eee; color: #333; }

        /* --- LIGHTBOX --- */
        .lightbox {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 999;
            display: none; align-items: center; justify-content: center;
            cursor: zoom-out;
        }
        .lightbox img {
            max-width: 90%; max-height: 90%;
            border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.5);
            animation: zoomIn 0.2s;
        }
        @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* --- MODAL --- */
        .modal-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 200; display: none; align-items: center; justify-content: center;
        }
        .modal-box { background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; }
        .close-btn { float: right; cursor: pointer; font-size: 1.5rem; border: none; background: none; }
    </style>
</head>
<body>

    <div id="lightbox" class="lightbox" onclick="closeLightbox()">
        <img id="lightbox-img" src="" alt="Zoom">
    </div>

    <header>
        <div class="points-box">
            <div class="total-row">
                <div class="total-points">
                    <span id="mainPts">0</span> / 40
                </div>
                <div class="free-points">
                    + <span id="freePts">0</span>/3 Attachment Points
                </div>
                <span id="commanderIndicator" class="commander-status status-missing">Commander Requis</span>
            </div>
            <div class="details-points" style="font-size:0.85rem; color:#777; margin-top:5px;">
                Co√ªt Unit√©s: <span id="unitPts">0</span> | Co√ªt Attachements: <span id="attPts">0</span>
            </div>
        </div>
        <div class="header-actions">
            <button class="btn-action btn-share" onclick="shareList()">Share List</button>
            <button class="btn-action btn-reset" onclick="resetAll()">Reset</button>
        </div>
    </header>

    <div class="faction-tabs">
        <button class="tab-btn stark-btn active" onclick="setFaction('House Stark')">House Stark</button>
        <button class="tab-btn bolton-btn" onclick="setFaction('House Bolton')">House Bolton</button>
    </div>

    <div class="container">
        <!-- MAGASIN -->
        <div class="column col-store">
            <h3>Battlefield Units</h3>
            <div id="store-combat" class="grid-store"></div>
            <h3>Council Units (NCU)</h3>
            <div id="store-ncu" class="grid-store"></div>
        </div>

        <!-- LISTE -->
        <div class="column col-roster">
            <div class="roster-header">BATTLEFIELD UNITS</div>
            <div id="roster-list-combat"></div>

            <div class="roster-header" style="margin-top: 20px;">COUNCIL UNITS</div>
            <div id="roster-list-ncu"></div>
        </div>
    </div>

    <div id="attModal" class="modal-bg">
        <div class="modal-box">
            <button class="close-btn" onclick="closeModal()">&times;</button>
            <h3 style="margin-top:0;">Choisir un Attachement</h3>
            <p id="commander-msg" style="font-size:0.8rem; color:#e67e22; display:none;">
                ‚ö† Un Commander est d√©j√† pr√©sent dans l'arm√©e.
            </p>
            <div id="att-store-grid" class="grid-store"></div>
        </div>
    </div>

    <script>
        // --- DATA ---
        const getImg = (name, color) => `https://via.placeholder.com/200x150/${color}/fff?text=${encodeURIComponent(name.replace(' (C)', ''))}`;

        const unitsDB = [
            // HOUSE STARK
            { id: 1, name: "Stark Sworn Sword", faction: "House Stark", type: "COMBAT", cost: 5, img: getImg("Sworn Sword", "2c3e50") },
            { id: 2, name: "House Umber Berserkers", faction: "House Stark", type: "COMBAT", cost: 6, img: getImg("Berserkers", "2c3e50") },
            { id: 3, name: "House Umber Greataxes", faction: "House Stark", type: "COMBAT", cost: 7, img: getImg("Greataxes", "2c3e50") },
            { id: 4, name: "House Umber Ravagers", faction: "House Stark", type: "COMBAT", cost: 7, img: getImg("Ravagers", "2c3e50") },
            { id: 5, name: "House Tully Cavaliers", faction: "House Stark", type: "COMBAT", cost: 8, img: getImg("Cavaliers", "2c3e50") },
            { id: 6, name: "House Tully Sworn Shields", faction: "House Stark", type: "COMBAT", cost: 6, img: getImg("Sworn Shields", "2c3e50") },
            { id: 7, name: "Stark Outriders", faction: "House Stark", type: "COMBAT", cost: 6, img: getImg("Outriders", "2c3e50") },
            { id: 8, name: "Stark Archers", faction: "House Stark", type: "COMBAT", cost: 6, img: getImg("Archers", "2c3e50") },
            { id: 20, name: "Catelyn Stark", faction: "House Stark", type: "NCU", cost: 5, img: getImg("Catelyn", "2c3e50") },
            { id: 21, name: "Sansa Stark", faction: "House Stark", type: "NCU", cost: 5, img: getImg("Sansa", "2c3e50") },
            { id: 22, name: "Rodrick Cassel", faction: "House Stark", type: "NCU", cost: 6, img: getImg("Rodrick", "2c3e50") },
            { id: 23, name: "Howland Reed", faction: "House Stark", type: "NCU", cost: 6, img: getImg("Howland", "2c3e50") },
            { id: 24, name: "Eddard Stark", faction: "House Stark", type: "NCU", cost: 7, img: getImg("Eddard", "2c3e50") },

            // HOUSE BOLTON
            { id: 50, name: "Dreadfort Cutthroats", faction: "House Bolton", type: "COMBAT", cost: 5, img: "https://asoiaf-tmg-discord-bot.s3.amazonaws.com/images/bolton-dreadfort-cutthroats-c.png" },
            { id: 51, name: "Dreadfort Spearmens", faction: "House Bolton", type: "COMBAT", cost: 5, img: getImg("Spearmens", "c0392b") },
            { id: 52, name: "Dreadfort Bastard's Girls", faction: "House Bolton", type: "COMBAT", cost: 7, img: "https://asoiaf-tmg-discord-bot.s3.amazonaws.com/images/bolton-bastards-girls-c.png" },
            { id: 53, name: "Dreadfort Flayed Men", faction: "House Bolton", type: "COMBAT", cost: 8, img: "https://asoiaf-tmg-discord-bot.s3.amazonaws.com/images/bolton-flayed-men-c.png" },
            { id: 54, name: "Dreadfort Archers", faction: "House Bolton", type: "COMBAT", cost: 6, img: getImg("Archers", "c0392b") },
            { id: 55, name: "Dreadfort Blackguards", faction: "House Bolton", type: "COMBAT", cost: 7, img: getImg("Blackguards", "c0392b") },
            { id: 56, name: "Bloody Mummers Skirmishers", faction: "House Bolton", type: "COMBAT", cost: 6, img: getImg("Skirmishers", "c0392b") },
            { id: 57, name: "Bloody Mummers Zorse Riders", faction: "House Bolton", type: "COMBAT", cost: 6, img: getImg("Zorse Riders", "c0392b") },
            { id: 70, name: "Ramsay Bolton", faction: "House Bolton", type: "NCU", cost: 5, img: getImg("Ramsay NCU", "c0392b") },
            { id: 71, name: "Walder Frey", faction: "House Bolton", type: "NCU", cost: 5, img: "https://asoiaf-tmg-discord-bot.s3.amazonaws.com/images/neutral-walder-frey-aoc-c.png" },
            { id: 72, name: "Jeyne Pool", faction: "House Bolton", type: "NCU", cost: 6, img: getImg("Jeyne", "c0392b") },
            { id: 73, name: "Walda Frey", faction: "House Bolton", type: "NCU", cost: 6, img: getImg("Walda", "c0392b") },
            { id: 74, name: "Roose Bolton", faction: "House Bolton", type: "NCU", cost: 7, img: "https://asoiaf-tmg-discord-bot.s3.amazonaws.com/images/bolton-roose-bolton-tll-c.png" }
        ];

        const attachmentsDB = [
            // STARK
            { id: 100, name: "Robb Stark (C)", faction: "House Stark", cost: 0, isCommander: true, img: getImg("Robb (C)", "f1c40f") },
            { id: 101, name: "Robb Stark", faction: "House Stark", cost: 2, isCommander: false, img: getImg("Robb", "2c3e50") },
            { id: 102, name: "Brynden Tully (C)", faction: "House Stark", cost: 0, isCommander: true, img: getImg("Brynden (C)", "f1c40f") },
            { id: 103, name: "Brynden Tully", faction: "House Stark", cost: 2, isCommander: false, img: getImg("Brynden", "2c3e50") },
            { id: 104, name: "Greatjon Umber (C)", faction: "House Stark", cost: 0, isCommander: true, img: getImg("Greatjon (C)", "f1c40f") },
            { id: 105, name: "Greatjon Umber", faction: "House Stark", cost: 2, isCommander: false, img: getImg("Greatjon", "2c3e50") },
            { id: 106, name: "Sworn Sword Captain", faction: "House Stark", cost: 1, isCommander: false, img: getImg("Capt", "2c3e50") },
            { id: 107, name: "Umber Champion", faction: "House Stark", cost: 1, isCommander: false, img: getImg("Champion", "2c3e50") },
            { id: 108, name: "Winterfell Guardian", faction: "House Stark", cost: 1, isCommander: false, img: getImg("Guardian", "2c3e50") },

            // BOLTON
            { id: 200, name: "Ramsay Snow (C)", faction: "House Bolton", cost: 0, isCommander: true, img: "https://asoiaf-tmg-discord-bot.s3.amazonaws.com/images/bolton-ramsay-snow-tbib-c.png" },
            { id: 201, name: "Ramsay Snow", faction: "House Bolton", cost: 2, isCommander: false, img: "https://asoiaf-tmg-discord-bot.s3.amazonaws.com/images/bolton-ramsay-snow-tbib-c.png" },
            { id: 202, name: "Roose Bolton (C)", faction: "House Bolton", cost: 0, isCommander: true, img: getImg("Roose (C)", "f1c40f") },
            { id: 203, name: "Roose Bolton", faction: "House Bolton", cost: 2, isCommander: false, img: getImg("Roose", "c0392b") },
            { id: 204, name: "Steelshanks Walton (C)", faction: "House Bolton", cost: 0, isCommander: true, img: getImg("Walton (C)", "f1c40f") },
            { id: 205, name: "Steelshanks Walton", faction: "House Bolton", cost: 2, isCommander: false, img: getImg("Walton", "c0392b") },
            { id: 206, name: "Vargo Hoat (C)", faction: "House Bolton", cost: 0, isCommander: true, img: getImg("Vargo (C)", "f1c40f") },
            { id: 207, name: "Vargo Hoat", faction: "House Bolton", cost: 2, isCommander: false, img: getImg("Vargo", "c0392b") },
            { id: 208, name: "Damon Dance-For-Me", faction: "House Bolton", cost: 1, isCommander: false, img: getImg("Damon", "c0392b") },
            { id: 209, name: "Ben Bones", faction: "House Bolton", cost: 1, isCommander: false, img: getImg("Ben Bones", "c0392b") },
            { id: 210, name: "Skinner", faction: "House Bolton", cost: 1, isCommander: false, img: getImg("Skinner", "c0392b") },
            { id: 211, name: "Sour Alyn", faction: "House Bolton", cost: 1, isCommander: false, img: getImg("Sour Alyn", "c0392b") },
            { id: 212, name: "Grunt", faction: "House Bolton", cost: 1, isCommander: false, img: getImg("Grunt", "c0392b") },
            { id: 213, name: "Rorge", faction: "House Bolton", cost: 2, isCommander: false, img: getImg("Rorge", "c0392b") },
            { id: 214, name: "Bitter", faction: "House Bolton", cost: 0, isCommander: false, img: getImg("Bitter", "c0392b") },
            { id: 215, name: "Theon Greyjoy", faction: "House Bolton", cost: 0, isCommander: false, img: getImg("Theon", "c0392b") },
            { id: 216, name: "Dreadfort Captain", faction: "House Bolton", cost: 1, isCommander: false, img: "https://asoiaf-tmg-discord-bot.s3.amazonaws.com/images/bolton-dreadfort-captain-c.png" },
            { id: 217, name: "Dreadfort Flayer", faction: "House Bolton", cost: 1, isCommander: false, img: getImg("Flayer", "c0392b") },
        ];

        // --- STATE ---
        const MAX_MAIN = 40;
        const MAX_FREE = 3;
        
        let activeFaction = "House Stark";
        let roster = [];
        let currentUnitIndex = null; 

        // --- INIT ---
        renderStore();
        updateUI();

        // --- LIGHTBOX ---
        function openLightbox(src) {
            document.getElementById('lightbox-img').src = src;
            document.getElementById('lightbox').style.display = 'flex';
        }
        function closeLightbox() { document.getElementById('lightbox').style.display = 'none'; }

        // --- LOGIC ---
        function setFaction(f) {
            activeFaction = f;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            if(f === 'House Stark') document.querySelector('.stark-btn').classList.add('active');
            else document.querySelector('.bolton-btn').classList.add('active');
            renderStore();
        }

        function isCommanderInRoster() {
            for(let item of roster) {
                if(item.attachments.some(a => a.isCommander)) return true;
            }
            return false;
        }

        function getCommanderName() {
            for(let item of roster) {
                const comm = item.attachments.find(a => a.isCommander);
                if(comm) return comm.name;
            }
            return "None";
        }

        // --- NEW CALCULATION LOGIC (40 + 3) ---
        function calculateStats() {
            let uPts = 0;
            let aPts = 0;
            roster.forEach(item => {
                uPts += item.unit.cost;
                item.attachments.forEach(a => aPts += a.cost);
            });

            // On d√©duit jusqu'√† 3 pts du total des attachements
            let freeUsed = Math.min(aPts, MAX_FREE);
            // Le reste des points d'attachements d√©borde sur le budget principal
            let attSpill = aPts - freeUsed;

            let mainUsed = uPts + attSpill;

            return {
                mainUsed,
                freeUsed,
                totalUnit: uPts,
                totalAtt: aPts
            };
        }

        function checkAffordability(cost, type) {
            const stats = calculateStats();
            
            // Si on ajoute une unit√©, √ßa tape direct dans le Main budget
            if(type === 'UNIT' || type === 'COMBAT' || type === 'NCU') {
                return (stats.mainUsed + cost) <= MAX_MAIN;
            } 
            // Si on ajoute un attachement, on doit recalculer le d√©bordement
            else {
                let newAttTotal = stats.totalAtt + cost;
                let newFreeUsed = Math.min(newAttTotal, MAX_FREE);
                let newSpill = newAttTotal - newFreeUsed;
                
                let newMainUsed = stats.totalUnit + newSpill;
                return newMainUsed <= MAX_MAIN;
            }
        }

        function renderStore() {
            const combatStore = document.getElementById('store-combat');
            const ncuStore = document.getElementById('store-ncu');
            combatStore.innerHTML = ''; ncuStore.innerHTML = '';
            
            const units = unitsDB.filter(u => u.faction === activeFaction);

            units.forEach(u => {
                const canAfford = checkAffordability(u.cost, 'UNIT');
                const el = createCard(u, canAfford, () => addUnit(u));
                if(u.type === 'COMBAT') combatStore.appendChild(el);
                else ncuStore.appendChild(el);
            });
        }

        function createCard(data, active, onClick) {
            const div = document.createElement('div');
            div.className = `card ${!active ? 'disabled' : ''}`;
            
            let badge = '';
            if(data.isCommander) badge = `<div class="commander-badge">COMMANDER</div>`;

            div.innerHTML = `
                ${badge}
                <div class="card-img-wrap" onclick="event.stopPropagation(); openLightbox('${data.img}')">
                    <img src="${data.img}" onerror="this.src='https://via.placeholder.com/150'">
                </div>
                <div class="card-info" onclick="${active ? 'addUnitByID(' + data.id + ')' : ''}">
                    <div class="card-name">${data.name}</div>
                    <div class="card-cost">${data.cost} pts</div>
                </div>
            `;
            div.querySelector('.card-info').onclick = active ? onClick : null;
            return div;
        }

        // --- ROSTER ACTIONS ---
        function addUnit(unit) {
            roster.push({ unit: {...unit}, attachments: [] });
            updateUI();
        }

        function removeUnit(idx) {
            roster.splice(idx, 1);
            updateUI();
        }

        function openAttModal(idx) {
            currentUnitIndex = idx;
            const modalGrid = document.getElementById('att-store-grid');
            modalGrid.innerHTML = '';
            
            const hasComm = isCommanderInRoster();
            const atts = attachmentsDB.filter(a => a.faction === roster[idx].unit.faction);

            document.getElementById('commander-msg').style.display = hasComm ? 'block' : 'none';

            atts.forEach(a => {
                let canAfford = checkAffordability(a.cost, 'ATTACHMENT');
                
                // R√®gle Commander
                if(a.isCommander && hasComm) canAfford = false;
                
                const el = createCard(a, canAfford, () => addAttachment(a));
                modalGrid.appendChild(el);
            });

            document.getElementById('attModal').style.display = 'flex';
        }

        function addAttachment(att) {
            if(currentUnitIndex !== null) {
                roster[currentUnitIndex].attachments.push({...att});
                closeModal();
                updateUI();
            }
        }

        function removeAttachment(uIdx, aIdx) {
            roster[uIdx].attachments.splice(aIdx, 1);
            updateUI();
        }

        function closeModal() { document.getElementById('attModal').style.display = 'none'; }
        function resetAll() { if(confirm('Tout effacer ?')) { roster = []; updateUI(); } }

        // --- UI RENDER ---
        function updateUI() {
            const stats = calculateStats();
            const hasComm = isCommanderInRoster();

            document.getElementById('mainPts').innerText = stats.mainUsed;
            document.getElementById('freePts').innerText = stats.freeUsed;
            
            document.getElementById('unitPts').innerText = stats.totalUnit;
            document.getElementById('attPts').innerText = stats.totalAtt;

            const commInd = document.getElementById('commanderIndicator');
            if(hasComm) {
                commInd.innerText = "Commander OK";
                commInd.className = "commander-status status-ok";
            } else {
                commInd.innerText = "Commander Requis";
                commInd.className = "commander-status status-missing";
            }

            renderStore();

            const listCombat = document.getElementById('roster-list-combat');
            const listNCU = document.getElementById('roster-list-ncu');
            listCombat.innerHTML = ''; listNCU.innerHTML = '';

            roster.forEach((item, idx) => {
                const el = document.createElement('div');
                el.className = 'roster-unit';

                let attHTML = '';
                if(item.unit.type === 'COMBAT') {
                    item.attachments.forEach((a, aIdx) => {
                        const styleComm = a.isCommander ? 'is-commander' : '';
                        const nameComm = a.isCommander ? 'üëë ' : '+ ';
                        attHTML += `
                            <div class="att-row ${styleComm}">
                                <span>${nameComm}${a.name}</span>
                                <div style="display:flex; gap:10px;">
                                    <b>${a.cost} pts</b>
                                    <span style="color:#c0392b; cursor:pointer;" onclick="removeAttachment(${idx}, ${aIdx})">X</span>
                                </div>
                            </div>
                        `;
                    });
                    attHTML += `<button class="btn-add" onclick="openAttModal(${idx})">+ Ajouter Attachement</button>`;
                }

                el.innerHTML = `
                    <div class="unit-header">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <img src="${item.unit.img}" class="unit-thumb" onclick="openLightbox('${item.unit.img}')">
                            <div>
                                <div><b>${item.unit.name}</b> <small>(${item.unit.type})</small></div>
                                <div style="color:#666; font-size:0.8rem;">${item.unit.cost} pts</div>
                            </div>
                        </div>
                        <button onclick="removeUnit(${idx})" style="border:none; bg:none; color:red; font-size:1.2rem; cursor:pointer;">&times;</button>
                    </div>
                    ${attHTML}
                `;

                if(item.unit.type === 'COMBAT') listCombat.appendChild(el);
                else listNCU.appendChild(el);
            });
        }
        
        async function shareList() {
            const stats = calculateStats();
            const commander = getCommanderName();
            const combatUnits = roster.filter(i => i.unit.type === 'COMBAT');
            const ncuUnits = roster.filter(i => i.unit.type === 'NCU');

            let text = `Faction: ${activeFaction}\n`;
            text += `Commander: ${commander}\n`;
            text += `Points: ${stats.mainUsed} / 40 (Free Att: ${stats.freeUsed}/3)\n\n`;

            if(combatUnits.length > 0) {
                text += `Battlefield Units\n`;
                combatUnits.forEach(item => {
                    text += ` ‚Ä¢ ${item.unit.name} (${item.unit.cost})\n`;
                    item.attachments.forEach(att => {
                        text += `     ${att.name} (${att.cost})\n`;
                    });
                });
                text += `\n`;
            }

            if(ncuUnits.length > 0) {
                text += `Council Units\n`;
                ncuUnits.forEach(item => {
                    text += ` ‚Ä¢ ${item.unit.name} (${item.unit.cost})\n`;
                });
            }

            try {
                await navigator.clipboard.writeText(text);
                const btn = document.querySelector('.btn-share');
                const prev = btn.innerText;
                btn.innerText = "Copi√© !";
                setTimeout(() => btn.innerText = prev, 2000);
            } catch (err) { alert("Erreur copie"); }
        }

        window.onclick = (e) => { if(e.target == document.getElementById('attModal')) closeModal(); }
    </script>
</body>
</html>
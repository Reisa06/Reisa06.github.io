<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reisa ASOIAF Builder</title>
    <style>
        :root {
            /* Couleurs de base (Mode Clair) */
            --bg: #f0f2f5;
            --component-bg: #ffffff;
            --text-main: #333333;
            --text-muted: #666666;
            --border: #dddddd;
            --hover-bg: #f9f9f9;
            
            /* Couleurs Factions & UI */
            --stark: #2c3e50;
            --bolton: #FEC3AC;
            --lannister: #b71c1c;
            --baratheon: #f39c12;
            --gold: #f1c40f;
            --share: #3498db;
            --tactics: #9b59b6;
            --zone: #607d8b;
            --terrain: #795548;
            --gamemode: #b7950b;
            --free-green: #27ae60;
            --feedback: #1b5e20;
            --special: #8e44ad;
            --pill-bg: #eafaf1;
            
            /* Ombres */
            --shadow: 0 2px 5px rgba(0,0,0,0.05);
            --header-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* MODE SOMBRE */
        body.dark-mode {
            --bg: #121212;
            --component-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-muted: #aaaaaa;
            --border: #333333;
            --hover-bg: #2a2a2a;
            --pill-bg: #1b3a29;
            --shadow: 0 2px 5px rgba(0,0,0,0.5);
            --header-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); margin: 0; padding: 20px; padding-bottom: 80px; color: var(--text-main); transition: background-color 0.3s, color 0.3s; }

        /* HEADER */
        header {
            position: sticky; top: 0; background: var(--component-bg); padding: 10px 20px;
            border-radius: 8px; box-shadow: var(--header-shadow);
            z-index: 100; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;
            transition: background 0.3s;
        }
        .points-box { display: flex; flex-direction: column; }
        .total-row { display: flex; align-items: baseline; gap: 10px; }
        .total-points { font-size: 2rem; font-weight: 800; color: var(--text-main); }
        .free-points { font-size: 0.9rem; color: var(--free-green); font-weight: bold; background: var(--pill-bg); padding: 4px 8px; border-radius: 4px; border: 1px solid var(--free-green); }
        .commander-status { font-size: 0.8rem; font-weight: bold; padding: 2px 6px; border-radius: 4px; margin-left: 5px; vertical-align: middle;}
        .status-ok { background: #dff9fb; color: #2ecc71; border: 1px solid #2ecc71; }
        body.dark-mode .status-ok { background: #133629; }
        
        .status-missing { background: #ff797933; color: #e74c3c; border: 1px solid #e74c3c; }
        .header-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn-action { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s;}
        .btn-reset { background: #e74c3c; }
        .btn-share { background: var(--share); }
        .btn-tactics { background: var(--tactics); }
        .btn-zone { background: var(--zone); }
        .btn-terrain { background: var(--terrain); }
        .btn-gamemode { background: var(--gamemode); }
        .btn-feedback { background: var(--feedback); }
        .btn-theme { background: var(--text-main); color: var(--bg); font-size: 1.2rem; padding: 5px 15px; display:flex; align-items:center; justify-content: center;}

        /* VERSION SELECTOR */
        .version-container {
            position: fixed; bottom: 20px; left: 20px; z-index: 1000;
            background: var(--component-bg); padding: 10px; border-radius: 8px;
            box-shadow: var(--shadow); border: 1px solid var(--border);
            display: flex; align-items: center; gap: 10px;
        }
        .version-label { font-weight: bold; font-size: 0.85rem; color: var(--text-muted); }
        #versionSelect { padding: 5px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg); color: var(--text-main); font-weight: bold; cursor: pointer; }

        /* TABS */
        .faction-tabs { display: flex; justify-content: center; margin-bottom: 20px; gap: 10px; flex-wrap: wrap; }
        .tab-btn { padding: 10px 25px; border: 2px solid transparent; background: var(--component-bg); cursor: pointer; font-weight: bold; border-radius: 20px; opacity: 0.7; transition: 0.3s; text-transform: uppercase; color: var(--text-muted); }
        .tab-btn.active { opacity: 1; border-color: currentColor; box-shadow: var(--shadow); }
        .stark-btn.active { color: var(--stark); } 
        .bolton-btn.active { color: var(--bolton); }
        .lannister-btn.active { color: var(--lannister); }
        .baratheon-btn.active { color: var(--baratheon); }
        body.dark-mode .stark-btn.active { color: #5dade2; }
        body.dark-mode .bolton-btn.active { color: #FEC3AC; }
        body.dark-mode .lannister-btn.active { color: #ff5252; }
        body.dark-mode .baratheon-btn.active { color: #f1c40f; }

        /* LAYOUT */
        .container { display: flex; gap: 20px; max-width: 1400px; margin: 0 auto; align-items: flex-start; }
        .column { background: var(--component-bg); padding: 20px; border-radius: 10px; box-shadow: var(--shadow); transition: background 0.3s; width: 100%; box-sizing: border-box; }
        .col-store { flex: 6; }
        .col-roster { flex: 4; position: sticky; top: 90px; max-height: 85vh; overflow-y: auto; }
        h3 { border-bottom: 2px solid var(--border); padding-bottom: 8px; margin-top: 25px; color: var(--text-muted); font-size: 0.9rem; text-transform: uppercase; }
        .roster-header { background: var(--hover-bg); padding: 8px; font-weight: bold; text-align: center; margin-bottom: 10px; border-radius: 4px; color: var(--text-muted); font-size: 0.85rem; letter-spacing: 1px; }

        /* CARDS */
        .grid-store { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 12px; }
        .card { border: 1px solid var(--border); border-radius: 6px; background: var(--component-bg); overflow: hidden; position: relative; transition: transform 0.2s; display: flex; flex-direction: column; }
        .card:hover { transform: translateY(-3px); box-shadow: var(--shadow); }
        
        .card.disabled { opacity: 0.5; filter: grayscale(1); }
        .card.disabled:hover { transform: none; box-shadow: none; }
        .card.disabled .card-info { pointer-events: none; cursor: not-allowed; }
        .card.disabled .card-img-wrap { pointer-events: auto; cursor: zoom-in; }

        .card-img-wrap { width: 100%; height: 80px; overflow: hidden; cursor: zoom-in; }
        .card img { width: 100%; height: 100%; object-fit: cover; object-position: top; transition: transform 0.3s; }
        .card-img-wrap:hover img { transform: scale(1.1); }
        .card-info { padding: 8px; text-align: center; cursor: pointer; flex-grow: 1; background: var(--component-bg); color: var(--text-main); display: flex; flex-direction: column; align-items: center; justify-content: space-between; }
        .card-info:hover { background: var(--hover-bg); }
        .card-name { font-weight: bold; font-size: 0.8rem; line-height: 1.2; height: 35px; display: flex; align-items: center; justify-content: center; overflow: hidden; width: 100%; }
        .card-cost { display: inline-block; background: #333; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; margin-top: 5px; }
        body.dark-mode .card-cost { background: #555; }
        .commander-badge { position: absolute; top: 0; left: 0; width: 100%; pointer-events: none; background: linear-gradient(90deg, #f1c40f, #f39c12); color: white; font-size: 0.7rem; font-weight: bold; text-align: center; padding: 2px 0; letter-spacing: 1px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 10; }
        .loyalty-badge { position: absolute; top: 20px; left: 0; width: 100%; pointer-events: none; color: white; font-size: 0.6rem; font-weight: bold; text-align: center; padding: 1px 0; letter-spacing: 1px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 10; opacity: 0.9;}
        .loyalty-stannis { background: #e67e22; }
        .loyalty-renly { background: #27ae60; }

        /* SPECIAL BUTTON */
        .btn-special { margin-top: 5px; background-color: var(--special); color: white; border: none; border-radius: 4px; padding: 2px 8px; font-size: 0.7rem; font-weight: bold; cursor: pointer; z-index: 20; }
        .btn-special:hover { filter: brightness(1.1); }

        /* ROSTER */
        .roster-unit { border: 1px solid var(--border); border-radius: 6px; margin-bottom: 15px; background: var(--component-bg); }
        .unit-header { padding: 10px; display: flex; justify-content: space-between; align-items: center; background: var(--component-bg); border-bottom: 1px solid var(--border); }
        .unit-thumb { width: 45px; height: 45px; border-radius: 4px; object-fit: cover; object-position: top; cursor: zoom-in; border: 1px solid var(--border);}
        .att-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; border-bottom: 1px solid var(--border); font-size: 0.85rem; background: var(--hover-bg); }
        .att-row.is-commander { background: #fffcf0; border-left: 3px solid var(--gold); }
        body.dark-mode .att-row.is-commander { background: #3b3618; border-left: 3px solid var(--gold); }
        .att-name-link { cursor: zoom-in; font-weight: bold; color: var(--text-main); transition: color 0.2s; }
        .att-name-link:hover { color: var(--share); text-decoration: underline; }
        .btn-add { width: 100%; border: 1px dashed var(--border); background: none; padding: 8px; cursor: pointer; color: var(--text-muted); }
        .btn-add:hover { background: var(--hover-bg); color: var(--text-main); }

        /* MODALS & LIGHTBOX */
        .lightbox { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 999; display: none; align-items: center; justify-content: center; cursor: zoom-out; }
        .lightbox-content { position: relative; display: flex; align-items: center; justify-content: center; max-width: 90%; max-height: 90vh; }
        .lightbox img { max-width: 100%; max-height: 90vh; border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.5); animation: zoomIn 0.2s; }
        
        .lightbox-nav { position: absolute; top: 50%; transform: translateY(-50%); font-size: 3rem; color: white; cursor: pointer; user-select: none; padding: 20px; background: rgba(0,0,0,0.3); border-radius: 50%; transition: 0.3s; z-index: 1001; }
        .lightbox-nav:hover { background: rgba(255,255,255,0.2); }
        .nav-left { left: -80px; } 
        .nav-right { right: -80px; }

        .modal-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 200; display: none; align-items: center; justify-content: center; }
        .modal-box { background: var(--component-bg); padding: 20px; border-radius: 8px; width: 90%; max-width: 600px; max-height: 85vh; overflow-y: auto; color: var(--text-main); }
        .close-btn { float: right; cursor: pointer; font-size: 1.5rem; border: none; background: none; color: var(--text-main); }
        @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* TACTICS & TERRAIN STYLES */
        .tactics-section { margin-bottom: 20px; }
        .tactics-title { font-weight: bold; font-size: 1.1rem; border-bottom: 2px solid var(--border); padding-bottom: 5px; margin-bottom: 10px; color: var(--tactics); }
        
        .tactics-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
        
        #terrain-grid { grid-template-columns: repeat(4, 1fr); }

        .tactic-card { border-radius: 6px; overflow: hidden; box-shadow: var(--shadow); cursor: zoom-in; transition: transform 0.2s; aspect-ratio: 2.5/3.5; background: #eee;}
        .tactic-card:hover { transform: translateY(-3px); }
        .tactic-card img { width: 100%; height: 100%; object-fit: cover; }

        /* SPECIAL LAYOUT CARD (TAROT FORMAT) */
        .special-card-container { display: flex; justify-content: center; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
        .special-card-container .tactic-card { width: 300px; aspect-ratio: 1.71/1.00; }

        /* ================= MOBILE RESPONSIVE ================= */
        @media screen and (max-width: 900px) {
            body { padding: 10px; padding-bottom: 80px; }
            header { flex-direction: column; align-items: stretch; gap: 15px; padding: 15px; }
            .points-box { align-items: center; text-align: center; }
            .total-row { justify-content: center; flex-wrap: wrap; }
            .header-actions { justify-content: space-between; gap: 8px; }
            .header-actions .btn-action { flex: 1 1 calc(33% - 10px); font-size: 0.85rem; padding: 12px 5px; display: flex; align-items: center; justify-content: center; }
            .faction-tabs { flex-wrap: wrap; }
            .tab-btn { flex: 1 1 40%; font-size: 0.9rem; padding: 10px; text-align: center; }
            .container { flex-direction: column; }
            .col-store, .col-roster { flex: none; width: 100%; }
            .col-roster { position: static; max-height: none; overflow: visible; }
            .grid-store { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); }
            .modal-box { width: 95%; max-height: 90vh; padding: 15px; }
            #terrain-grid { grid-template-columns: repeat(3, 1fr); }
            .special-card-container .tactic-card { width: 100%; max-width: 300px; }
            .lightbox-content { max-width: 100%; }
            .nav-left { left: 10px; }
            .nav-right { right: 10px; }
            .lightbox-nav { font-size: 2rem; padding: 10px; }
        }

        @media screen and (max-width: 480px) {
            .header-actions .btn-action { flex: 1 1 calc(50% - 10px); } 
            #terrain-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>

    <div class="version-container">
        <span class="version-label">Version:</span>
        <select id="versionSelect" onchange="changeVersion(this.value)">
            <option value="12/2025" selected>12/2025</option>
            <option value="01/2026">01/2026</option>
        </select>
    </div>

    <div id="lightbox" class="lightbox" onclick="closeLightbox()">
        <div class="lightbox-content">
            <span id="lb-prev" class="lightbox-nav nav-left" onclick="changeLightboxImage(-1)">&#10094;</span>
            <img id="lightbox-img" src="" alt="Zoom">
            <span id="lb-next" class="lightbox-nav nav-right" onclick="changeLightboxImage(1)">&#10095;</span>
        </div>
    </div>

    <header>
        <div class="points-box">
            <div class="total-row">
                <div class="total-points"><span id="mainPts">0</span> / 50</div>
                <div class="free-points">+ <span id="freePts">0</span>/3 Attachment Points</div>
                <span id="commanderIndicator" class="commander-status status-missing">Commander Required</span>
            </div>
            <div class="details-points" style="font-size:0.85rem; color:var(--text-muted); margin-top:5px;">
                Cost Units: <span id="unitPts">0</span> | Cost Attachments: <span id="attPts">0</span>
            </div>
        </div>
        <div class="header-actions">
            <button class="btn-action btn-theme" onclick="toggleTheme()" title="Changer le thÃ¨me">ðŸŒ—</button>
            <button class="btn-action btn-feedback" onclick="openFeedbackModal()">Feedback</button>
            <button class="btn-action btn-terrain" onclick="openTerrainModal()">Terrain</button>
            <button class="btn-action btn-gamemode" onclick="openGameModeModal()">Game Modes</button>
            <button id="btnFactionZone" class="btn-action btn-zone" onclick="openFactionZoneModal()">Faction Zone</button>
            <button class="btn-action btn-tactics" onclick="openTacticsModal()">Tactics Cards</button>
            <button class="btn-action btn-share" onclick="shareList()">Share List</button>
            <button class="btn-action btn-reset" onclick="resetAll()">Reset</button>
        </div>
    </header>

    <div class="faction-tabs">
        <button id="tabStark" class="tab-btn stark-btn active" onclick="setFaction('House Stark')">House Stark</button>
        <button id="tabBolton" class="tab-btn bolton-btn" onclick="setFaction('House Bolton')">House Bolton</button>
        <button id="tabLannister" class="tab-btn lannister-btn" onclick="setFaction('House Lannister')">House Lannister</button>
        <button id="tabBaratheon" class="tab-btn baratheon-btn" onclick="setFaction('House Baratheon')">House Baratheon</button>
    </div>

    <div class="container">
        <div class="column col-store">
            <h3>Battlefield Units</h3>
            <div id="store-combat" class="grid-store"></div>
            <h3>Council Units</h3>
            <div id="store-ncu" class="grid-store"></div>
        </div>
        <div class="column col-roster">
            <div class="roster-header">BATTLEFIELD UNITS</div>
            <div id="roster-list-combat"></div>
            <div class="roster-header" style="margin-top: 20px;">COUNCIL UNITS</div>
            <div id="roster-list-ncu"></div>
        </div>
    </div>

    <div id="attModal" class="modal-bg">
        <div class="modal-box" style="max-width: 500px;">
            <button class="close-btn" onclick="closeModal('attModal')">&times;</button>
            <h3>Choisir un Attachement</h3>
            <p id="commander-msg" style="font-size:0.8rem; color:#e67e22; display:none;">âš  Un Commander est dÃ©jÃ  prÃ©sent.</p>
            <div id="att-store-grid" class="grid-store"></div>
        </div>
    </div>

    <div id="tacticsModal" class="modal-bg">
        <div class="modal-box">
            <button class="close-btn" onclick="closeModal('tacticsModal')">&times;</button>
            <h2 style="margin-top:0; color:var(--text-main);">Tactics Cards</h2>
            <div class="tactics-section">
                <div class="tactics-title" id="faction-tactics-title">Faction Cards</div>
                <div id="baratheon-choice" style="display:none; text-align:center; margin-bottom:15px;">
                    <button class="btn-action" style="background:#e67e22;" onclick="renderDeck('House Baratheon (Stannis)')">Stannis Deck</button>
                    <button class="btn-action" style="background:#27ae60;" onclick="renderDeck('House Baratheon (Renly)')">Renly Deck</button>
                </div>
                <div class="tactics-grid" id="faction-tactics-grid"></div>
            </div>
            <div class="tactics-section">
                <div class="tactics-title" id="commander-tactics-title">Commander Cards</div>
                <div class="tactics-grid" id="commander-tactics-grid"></div>
                <p id="no-commander-msg" style="color:var(--text-muted); font-style:italic; text-align:center;">No Commander selected.</p>
            </div>
        </div>
    </div>

    <div id="factionZoneModal" class="modal-bg">
        <div class="modal-box">
            <button class="close-btn" onclick="closeModal('factionZoneModal')">&times;</button>
            <h2 style="margin-top:0; color:var(--text-main);">Faction Zone Cards</h2>
            <div class="tactics-grid" id="faction-zone-grid"></div>
        </div>
    </div>

    <div id="terrainModal" class="modal-bg">
        <div class="modal-box">
            <button class="close-btn" onclick="closeModal('terrainModal')">&times;</button>
            <h2 style="margin-top:0; color:var(--text-main);">Terrain & Layouts</h2>
            <div class="special-card-container" id="terrain-special"></div>
            <div class="tactics-grid" id="terrain-grid"></div>
        </div>
    </div>

    <div id="gameModeModal" class="modal-bg">
        <div class="modal-box" style="max-width: 500px;">
            <button class="close-btn" onclick="closeModal('gameModeModal')">&times;</button>
            <h2 style="margin-top:0; color:var(--text-main);">Game Modes</h2>
            <div class="tactics-grid" id="gamemode-grid"></div>
        </div>
    </div>

    <div id="feedbackModal" class="modal-bg">
        <div class="modal-box" style="max-width: 550px; text-align: center;">
            <button class="close-btn" onclick="closeModal('feedbackModal')">&times;</button>
            <h2 style="margin-top:0; color:var(--text-main);">Pre-Season Feedback</h2>
            
            <p style="margin-bottom: 20px;">Download this pdf feel free to complete this and submit it to:</p>
            
            <!-- Section PDF -->
            <div style="background: var(--hover-bg); padding: 15px; border-radius: 8px; margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                <a href="https://asoiaf.cmon.com/wp-content/uploads/2025/12/Pre-Season-Feedback-2025.12.07.pdf" target="_blank" style="color:var(--share); font-weight:bold; word-break: break-all; text-align:left; margin-right:10px;">Pre-Season-Feedback-2025.12.07.pdf</a>
                <button class="btn-action btn-share" onclick="window.open('https://asoiaf.cmon.com/wp-content/uploads/2025/12/Pre-Season-Feedback-2025.12.07.pdf', '_blank')" style="min-width: 80px;">Open</button>
            </div>
    
            <!-- Section Email -->
            <div style="background: var(--hover-bg); padding: 15px; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                <span id="cmonEmail" style="font-family: monospace; font-size: 1.1rem; font-weight: bold; word-break: break-all;">songtesting@cmon.com</span>
                <button class="btn-action btn-feedback" onclick="copyEmail()" style="min-width: 80px;">Copy</button>
            </div>
        </div>
    </div>

    <script>
        function toggleTheme() { document.body.classList.toggle('dark-mode'); localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light'); }
        (function() { if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode'); })();

        // CONSTANT BASE URLS
        const REPO_URL_12_25 = "https://raw.githubusercontent.com/Pf2eTools/mcl-documents/master/assets/2026/v01";
        const REPO_URL_01_26 = "https://raw.githubusercontent.com/Pf2eTools/mcl-documents/master/assets/2026/january-v1";

        // Helper function to generate Relative Image URLs
        const img = (faction, type, file) => {
            return `${faction}/${type}/${file}`;
        };
        const gameImg = (file) => `game/${file}`;

        const getBaseName = (name) => name.replace(' (C)', '').trim();

        // VERSION CONFIGURATION
        const VERSION_CONFIG = {
            "12/2025": {
                factions: ["House Stark", "House Bolton", "House Lannister", "House Baratheon"],
                features: ["factionZone"],
                baseUrl: REPO_URL_12_25
            },
            "01/2026": {
                factions: ["House Stark", "House Lannister"],
                features: [], // No faction zone
                baseUrl: REPO_URL_01_26
            }
        };

        const unitsDB = [
            // STARK
            { id: 1, name: "Stark Sworn Sword", faction: "House Stark", type: "COMBAT", cost: 5, unitType: "Infantry", img: img('stark','units','ss.png') },
            { id: 2, name: "House Umber Berserkers", faction: "House Stark", type: "COMBAT", cost: 6, unitType: "Infantry", img: img('stark','units','ub.png') },
            { id: 3, name: "House Umber Greataxes", faction: "House Stark", type: "COMBAT", cost: 7, unitType: "Infantry", img: img('stark','units','ug.png'), excludeVersions: ["01/2026"] },
            { id: 4, name: "House Umber Ravagers", faction: "House Stark", type: "COMBAT", cost: 7, unitType: "Cavalry", img: img('stark','units','ur.png'), excludeVersions: ["01/2026"] },
            { id: 5, name: "House Tully Cavaliers", faction: "House Stark", type: "COMBAT", cost: 8, unitType: "Cavalry", img: img('stark','units','tc.png'), excludeVersions: ["01/2026"] },
            { id: 6, name: "House Tully Sworn Shields", faction: "House Stark", type: "COMBAT", cost: 6, unitType: "Infantry", img: img('stark','units','ts.png'), excludeVersions: ["01/2026"] },
            { id: 7, name: "Stark Outriders", faction: "House Stark", type: "COMBAT", cost: 6, unitType: "Cavalry", img: img('stark','units','or.png'), excludeVersions: ["01/2026"] },
            { id: 7, name: "Stark Outriders", faction: "House Stark", type: "COMBAT", cost: 6, unitType: "Cavalry", img: img('stark','units','so.png'), onlyVersions: ["01/2026"] },
            { id: 8, name: "Stark Bowmen", faction: "House Stark", type: "COMBAT", cost: 6, unitType: "Infantry", img: img('stark','units','bm.png'), excludeVersions: ["01/2026"] },
            { id: 8, name: "Stark Bowmen", faction: "House Stark", type: "COMBAT", cost: 6, unitType: "Infantry", img: img('stark','units','sb.png'), onlyVersions: ["01/2026"] },
            { id: 9, name: "Grey Wind", faction: "House Stark", type: "COMBAT", cost: 3, unitType: "Monster", isUnique: true, req: "Robb Stark", img: img('stark','units','gw.png') },
            { id: 10, name: "Crannogman Trackers", faction: "House Stark", type: "COMBAT", cost: 5, unitType: "Infantry", img: img('stark','units','crackers.png'), excludeVersions: ["01/2026"] },
            { id: 11, name: "Crannogman Bog Devils", faction: "House Stark", type: "COMBAT", cost: 7, unitType: "Infantry", img: img('stark','units','cb.png'), special: { name: "Crannog Poison", img: "https://i.imgur.com/gzQ6a5B.jpeg" }, excludeVersions: ["01/2026"] },
            { id: 12, name: "House Karstark Spearmen", faction: "House Stark", type: "COMBAT", cost: 6, unitType: "Infantry", img: img('stark','units','ks.png'), onlyVersions: ["01/2026"] },
            
            { id: 20, name: "Catelyn Stark", faction: "House Stark", type: "NCU", cost: 5, isUnique: true, img: img('stark','ncu','cs.png') },
            { id: 21, name: "Sansa Stark", faction: "House Stark", type: "NCU", cost: 5, isUnique: true, img: img('stark','ncu','ss.png') },
            { id: 22, name: "Rodrick Cassel", faction: "House Stark", type: "NCU", cost: 6, isUnique: true, img: img('stark','ncu','rc.png'), excludeVersions: ["01/2026"] },
            { id: 22, name: "Rodrick Cassel", faction: "House Stark", type: "NCU", cost: 5, isUnique: true, img: img('stark','ncu','rc.png'), onlyVersions: ["01/2026"] },
            { id: 23, name: "Howland Reed", faction: "House Stark", type: "NCU", cost: 6, isUnique: true, img: img('stark','ncu','hr.png'), excludeVersions: ["01/2026"] },
            { id: 23, name: "Howland Reed", faction: "House Stark", type: "NCU", cost: 5, isUnique: true, img: img('stark','ncu','hr.png'), onlyVersions: ["01/2026"] },
            { id: 24, name: "Eddard Stark", faction: "House Stark", type: "NCU", cost: 7, isUnique: true, img: img('stark','ncu','es.png'), excludeVersions: ["01/2026"] },
            
            // BOLTON (Only 12/2025)
            { id: 50, name: "Dreadfort Cutthroats", faction: "House Bolton", type: "COMBAT", cost: 5, unitType: "Infantry", img: img('bolton','units','ct.png') },
            { id: 51, name: "Dreadfort Spearmen", faction: "House Bolton", type: "COMBAT", cost: 5, unitType: "Infantry", img: img('bolton','units','sp.png') },
            { id: 52, name: "Dreadfort Bastard's Girls", faction: "House Bolton", type: "COMBAT", cost: 7, unitType: "Infantry", img: img('bolton','units','bg.png') },
            { id: 53, name: "Dreadfort Flayed Men", faction: "House Bolton", type: "COMBAT", cost: 8, unitType: "Cavalry", img: img('bolton','units','fm.png') },
            { id: 54, name: "Dreadfort Archers", faction: "House Bolton", type: "COMBAT", cost: 6, unitType: "Infantry", img: img('bolton','units','a.png') },
            { id: 55, name: "Dreadfort Blackguards", faction: "House Bolton", type: "COMBAT", cost: 7, unitType: "Infantry", img: img('bolton','units','db.png') },
            { id: 56, name: "Bloody Mummer Skirmishers", faction: "House Bolton", type: "COMBAT", cost: 6, unitType: "Infantry", img: img('bolton','units','ms.png') },
            { id: 57, name: "Bloody Mummer Zorse Riders", faction: "House Bolton", type: "COMBAT", cost: 6, unitType: "Cavalry", img: img('bolton','units','mz.png') },
            
            { id: 69, name: "Tybald", faction: "House Bolton", type: "NCU", cost: 6, isUnique: true, img: img('bolton','ncu','t.png') },
            { id: 70, name: "Ramsay Snow", faction: "House Bolton", type: "NCU", cost: 5, isUnique: true, img: img('bolton','ncu','rs.png') },
            { id: 71, name: "Walder Frey", faction: "House Bolton", type: "NCU", cost: 5, isUnique: true, img: img('bolton','ncu','wf.png') },
            { id: 72, name: "Jeyne Poole", faction: "House Bolton", type: "NCU", cost: 6, isUnique: true, img: img('bolton','ncu','jp.png') },
            { id: 73, name: "Walda Frey", faction: "House Bolton", type: "NCU", cost: 6, isUnique: true, img: img('bolton','ncu','fw.png') },
            { id: 74, name: "Roose Bolton", faction: "House Bolton", type: "NCU", cost: 7, isUnique: true, img: img('bolton','ncu','rb.png') },

            // LANNISTER
            { id: 80, name: "Knights of Casterly Rock", faction: "House Lannister", type: "COMBAT", cost: 8, unitType: "Cavalry", img: img('lannister','units','k.png'), excludeVersions: ["01/2026"] },
            { id: 81, name: "House Clegane Mountain's Men", faction: "House Lannister", type: "COMBAT", cost: 7, unitType: "Infantry", img: img('lannister','units','mm.png') },
            { id: 82, name: "Lannisport City Watch", faction: "House Lannister", type: "COMBAT", cost: 6, unitType: "Infantry", img: img('lannister','units','cw.png'), excludeVersions: ["01/2026"] },
            { id: 83, name: "Lannister Crossbowmen", faction: "House Lannister", type: "COMBAT", cost: 6, unitType: "Infantry", img: img('lannister','units','cb.png'), excludeVersions: ["01/2026"] },
            { id: 83, name: "Lannister Crossbowmen", faction: "House Lannister", type: "COMBAT", cost: 6, unitType: "Infantry", img: img('lannister','units','lc.png'), onlyVersions: ["01/2026"] },
            { id: 84, name: "Lannister Guardsmen", faction: "House Lannister", type: "COMBAT", cost: 5, unitType: "Infantry", img: img('lannister','units','lg.png') },
            { id: 85, name: "Lannister Halberdiers", faction: "House Lannister", type: "COMBAT", cost: 5, unitType: "Infantry", img: img('lannister','units','lh.png') },
            { id: 86, name: "Brigands Clegane", faction: "House Lannister", type: "COMBAT", cost: 6, unitType: "Cavalry", img: img('lannister','units','cb.png'), onlyVersions: ["01/2026"] },

            { id: 90, name: "Joffrey Baratheon", faction: "House Lannister", type: "NCU", cost: 5, isUnique: true, img: img('lannister','ncu','jb.png') },
            { id: 91, name: "Pycelle", faction: "House Lannister", type: "NCU", cost: 5, isUnique: true, img: img('lannister','ncu','p.png'), excludeVersions: ["01/2026"] },
            { id: 92, name: "Qyburn", faction: "House Lannister", type: "NCU", cost: 5, isUnique: true, img: img('lannister','ncu','q.png') },
            { id: 93, name: "Cersei Lannister", faction: "House Lannister", type: "NCU", cost: 6, isUnique: true, img: img('lannister','ncu','cl.png'), excludeVersions: ["01/2026"] },
            { id: 93, name: "Cersei Lannister", faction: "House Lannister", type: "NCU", cost: 5, isUnique: true, img: img('lannister','ncu','cl.png'), onlyVersions: ["01/2026"] },
            { id: 94, name: "Tyrion Lannister", faction: "House Lannister", type: "NCU", cost: 6, isUnique: true, img: img('lannister','ncu','tl.png'), excludeVersions: ["01/2026"] },
            { id: 94, name: "Tyrion Lannister", faction: "House Lannister", type: "NCU", cost: 5, isUnique: true, img: img('lannister','ncu','tl.png'), onlyVersions: ["01/2026"] },

            // BARATHEON (Only 12/2025)
            { id: 400, name: "Baratheon Wardens", faction: "House Baratheon", type: "COMBAT", cost: 5, unitType: "Infantry", img: img('baratheon','units','bw.png') },
            { id: 401, name: "Baratheon Sentinels", faction: "House Baratheon", type: "COMBAT", cost: 6, unitType: "Infantry", img: img('baratheon','units','bs.png') },
            { id: 402, name: "Baratheon Halberdiers", faction: "House Baratheon", type: "COMBAT", cost: 6, unitType: "Infantry", img: img('baratheon','units','bh.png') },
            { id: 403, name: "Stag Knights", faction: "House Baratheon", type: "COMBAT", cost: 8, unitType: "Infantry", img: img('baratheon','units','sk.png') },
            { id: 404, name: "Champions of the Stag", faction: "House Baratheon", type: "COMBAT", cost: 8, unitType: "Cavalry", img: img('baratheon','units','cots.png') },
            { id: 405, name: "Queen's Men", faction: "House Baratheon", type: "COMBAT", cost: 7, unitType: "Infantry", loyalty: "Stannis", img: img('baratheon','units','qm.png') },
            { id: 406, name: "King's Men", faction: "House Baratheon", type: "COMBAT", cost: 7, unitType: "Infantry", loyalty: "Stannis", img: img('baratheon','units','km.png') },
            { id: 407, name: "Rose Knights", faction: "House Baratheon", type: "COMBAT", cost: 7, unitType: "Infantry", loyalty: "Renly", img: img('baratheon','units','rk.png') },
            { id: 408, name: "Thorn Watch", faction: "House Baratheon", type: "COMBAT", cost: 7, unitType: "Infantry", loyalty: "Renly", img: img('baratheon','units','tw.png') },
            { id: 450, name: "Margaery Tyrell", faction: "House Baratheon", type: "NCU", cost: 6, isUnique: true, loyalty: "Renly", img: img('baratheon','ncu','mt.png') },
            { id: 451, name: "Olenna Tyrell", faction: "House Baratheon", type: "NCU", cost: 6, isUnique: true, loyalty: "Renly", img: img('baratheon','ncu','ot.png') },
            { id: 452, name: "Davos Seaworth", faction: "House Baratheon", type: "NCU", cost: 6, isUnique: true, loyalty: "Stannis", img: img('baratheon','ncu','ds.png') },
            { id: 453, name: "Melisandre", faction: "House Baratheon", type: "NCU", cost: 6, isUnique: true, loyalty: "Stannis", img: img('baratheon','ncu','m.png') },
            { id: 454, name: "Alester Florent", faction: "House Baratheon", type: "NCU", cost: 5, isUnique: true, img: img('baratheon','ncu','af.png') },
            { id: 455, name: "Shyra Errol", faction: "House Baratheon", type: "NCU", cost: 5, isUnique: true, img: img('baratheon','ncu','who.png') }
        ];

        const attachmentsDB = [
            // STARK
            { id: 100, name: "Robb Stark (C)", faction: "House Stark", cost: 0, isCommander: true, isUnique: true, attType: 1, unitType: "Infantry", img: img('stark','attachments','rs.png') },
            { id: 101, name: "Robb Stark", faction: "House Stark", cost: 2, isCommander: false, isUnique: true, attType: 1, unitType: "Infantry", img: img('stark','attachments','rs.png') },
            { id: 102, name: "Brynden Tully (C)", faction: "House Stark", cost: 0, isCommander: true, isUnique: true, attType: 1, unitType: "Infantry", img: img('stark','attachments','bt.png'), excludeVersions: ["01/2026"] },
            { id: 103, name: "Brynden Tully", faction: "House Stark", cost: 2, isCommander: false, isUnique: true, attType: 1, unitType: "Infantry", img: img('stark','attachments','bt.png'), excludeVersions: ["01/2026"] },
            { id: 104, name: "Greatjon Umber (C)", faction: "House Stark", cost: 0, isCommander: true, isUnique: true, attType: 1, unitType: "Infantry", img: img('stark','attachments','gu.png') },
            { id: 105, name: "Greatjon Umber", faction: "House Stark", cost: 2, isCommander: false, isUnique: true, attType: 1, unitType: "Infantry", img: img('stark','attachments','gu.png') },
            { id: 106, name: "Sworn Sword Captain", faction: "House Stark", cost: 1, isCommander: false, isUnique: false, attType: 1, unitType: "Infantry", img: img('stark','attachments','ss.png') },
            { id: 107, name: "Umber Champion", faction: "House Stark", cost: 1, isCommander: false, isUnique: false, attType: 1, unitType: "Infantry", img: img('stark','attachments','uc.png') },
            { id: 108, name: "Winterfell Guardian", faction: "House Stark", cost: 1, isCommander: false, isUnique: false, attType: 1, unitType: "Cavalry", img: img('stark','attachments','wg.png'), excludeVersions: ["01/2026"] },
            { id: 109, name: "Howland Reed (C)", faction: "House Stark", cost: 0, isCommander: true, isUnique: true, attType: 1, unitType: "Infantry", img: img('stark','attachments','hr.png'), excludeVersions: ["01/2026"] }, 
            { id: 110, name: "Howland Reed", faction: "House Stark", cost: 2, isCommander: false, isUnique: true, attType: 1, unitType: "Infantry", img: img('stark','attachments','hr.png'), excludeVersions: ["01/2026"] },
            { id: 111, name: "Crannogman Warden", faction: "House Stark", cost: 1, isCommander: false, isUnique: false, attType: 1, unitType: "Infantry", img: img('stark','attachments','cw.png'), excludeVersions: ["01/2026"] },
            
            // BOLTON
            { id: 200, name: "Ramsay Snow (C)", faction: "House Bolton", cost: 0, isCommander: true, isUnique: true, attType: 1, unitType: "Infantry", img: img('bolton','attachments','rs.png') },
            { id: 201, name: "Ramsay Snow", faction: "House Bolton", cost: 2, isCommander: false, isUnique: true, attType: 1, unitType: "Infantry", img: img('bolton','attachments','rs.png') },
            { id: 202, name: "Roose Bolton (C)", faction: "House Bolton", cost: 0, isCommander: true, isUnique: true, attType: 1, unitType: "Infantry", img: img('bolton','attachments','rb.png') },
            { id: 203, name: "Roose Bolton", faction: "House Bolton", cost: 2, isCommander: false, isUnique: true, attType: 1, unitType: "Infantry", img: img('bolton','attachments','rb.png') },
            { id: 204, name: "Steelshanks Walton (C)", faction: "House Bolton", cost: 0, isCommander: true, isUnique: true, attType: 1, unitType: "Infantry", img: img('bolton','attachments','sw.png') },
            { id: 205, name: "Steelshanks Walton", faction: "House Bolton", cost: 2, isCommander: false, isUnique: true, attType: 1, unitType: "Infantry", img: img('bolton','attachments','sw.png') },
            { id: 206, name: "Vargo Hoat (C)", faction: "House Bolton", cost: 0, isCommander: true, isUnique: true, attType: 1, unitType: "Infantry", img: img('bolton','attachments','vh.png') },
            { id: 207, name: "Vargo Hoat", faction: "House Bolton", cost: 2, isCommander: false, isUnique: true, attType: 1, unitType: "Infantry", img: img('bolton','attachments','vh.png') },
            { id: 208, name: "Damon Dance-For-Me", faction: "House Bolton", cost: 1, isCommander: false, isUnique: true, attType: 3, unitType: "Infantry", img: img('bolton','attachments','dd.png') },
            { id: 209, name: "Ben Bones", faction: "House Bolton", cost: 1, isCommander: false, isUnique: true, attType: 3, unitType: "Infantry", img: img('bolton','attachments','bb.png') },
            { id: 210, name: "Skinner", faction: "House Bolton", cost: 1, isCommander: false, isUnique: true, attType: 3, unitType: "Infantry", img: img('bolton','attachments','s.png') },
            { id: 211, name: "Sour Alyn", faction: "House Bolton", cost: 1, isCommander: false, isUnique: true, attType: 3, unitType: "Infantry", img: img('bolton','attachments','sa.png') },
            { id: 212, name: "Grunt", faction: "House Bolton", cost: 1, isCommander: false, isUnique: true, attType: 3, unitType: "Infantry", img: img('bolton','attachments','g.png') },
            { id: 213, name: "Rorge", faction: "House Bolton", cost: 2, isCommander: false, isUnique: true, attType: 1, unitType: "Infantry", img: img('bolton','attachments','ro.png') },
            { id: 214, name: "Bitter", faction: "House Bolton", cost: 0, isCommander: false, isUnique: true, attType: 4, req: "Rorge", unitType: "Infantry", img: img('bolton','attachments','bi.png') },
            { id: 215, name: "Theon Greyjoy", faction: "House Bolton", cost: 0, isCommander: false, isUnique: true, attType: 4, req: "Ramsay Snow", unitType: "Infantry", img: img('bolton','attachments','r.png') },
            { id: 216, name: "Dreadfort Captain", faction: "House Bolton", cost: 1, isCommander: false, isUnique: false, attType: 1, unitType: "Infantry", img: img('bolton','attachments','dc.png') },
            { id: 217, name: "Dreadfort Flayer", faction: "House Bolton", cost: 1, isCommander: false, isUnique: false, attType: 1, unitType: "Infantry", img: img('bolton','attachments','df.png') },

            // LANNISTER
            { id: 300, name: "Jaime Lannister (C)", faction: "House Lannister", cost: 0, isCommander: true, isUnique: true, attType: 1, unitType: "Infantry", img: img('lannister','attachments','jl.png') },
            { id: 301, name: "Jaime Lannister", faction: "House Lannister", cost: 2, isCommander: false, isUnique: true, attType: 1, unitType: "Infantry", img: img('lannister','attachments','jl.png') },
            { id: 302, name: "Tyrion Lannister (C)", faction: "House Lannister", cost: 0, isCommander: true, isUnique: true, attType: 1, unitType: "Infantry", img: img('lannister','attachments','tl_b.png'), excludeVersions: ["01/2026"] },
            { id: 303, name: "Tyrion Lannister", faction: "House Lannister", cost: 2, isCommander: false, isUnique: true, attType: 1, unitType: "Infantry", img: img('lannister','attachments','tl_b.png'), excludeVersions: ["01/2026"] },
            { id: 304, name: "Gregor Clegane (C)", faction: "House Lannister", cost: 0, isCommander: true, isUnique: true, attType: 1, unitType: "Infantry", img: img('lannister','attachments','gc_b.png') },
            { id: 305, name: "Gregor Clegane", faction: "House Lannister", cost: 2, isCommander: false, isUnique: true, attType: 1, unitType: "Infantry", img: img('lannister','attachments','gc_b.png') },
            { id: 306, name: "Guard Captain", faction: "House Lannister", cost: 1, isCommander: false, isUnique: false, attType: 1, unitType: "Infantry", img: img('lannister','attachments','gc2.png'), excludeVersions: ["01/2026"] },
            { id: 306, name: "Guard Captain", faction: "House Lannister", cost: 1, isCommander: false, isUnique: false, attType: 1, unitType: "Infantry", img: img('lannister','attachments','c.png'), onlyVersions: ["01/2026"] },
            { id: 307, name: "Assault Veteran", faction: "House Lannister", cost: 1, isCommander: false, isUnique: false, attType: 1, unitType: "Infantry", img: img('lannister','attachments','av.png') },

            // BARATHEON
            { id: 500, name: "Stannis Baratheon (C) - The Rightful Heir", faction: "House Baratheon", cost: 0, isCommander: true, isUnique: true, loyalty: "Stannis", attType: 1, unitType: "Infantry", img: img('baratheon','attachments','sm.png') },
            { id: 501, name: "Renly Baratheon (C) - The Charismatic Heir", faction: "House Baratheon", cost: 0, isCommander: true, isUnique: true, loyalty: "Renly", attType: 1, unitType: "Infantry", img: img('baratheon','attachments','rb.png') },
            { id: 502, name: "Stag Knight Noble", faction: "House Baratheon", cost: 1, isCommander: false, isUnique: false, attType: 1, unitType: "Infantry", img: img('baratheon','attachments','sk.png') },
            { id: 503, name: "Master Warden", faction: "House Baratheon", cost: 1, isCommander: false, isUnique: false, attType: 1, unitType: "Infantry", img: img('baratheon','attachments','mw.png') }
        ];

        // Functions to get Decks dynamically based on version
        function getFactionDecks(version) {
            if (version === "01/2026") {
                return {
                    "House Stark": [
                        { name: "1", img: img('stark','tactics','1.png') },
                        { name: "2", img: img('stark','tactics','2.png') },
                        { name: "3", img: img('stark','tactics','3.png') },
                        { name: "4", img: img('stark','tactics','4.png') },
                        { name: "5", img: img('stark','tactics','5.png') },
                        { name: "6", img: img('stark','tactics','6.png') },
                        { name: "7", img: img('stark','tactics','7.png') }
                    ],
                    "House Lannister": [
                        { name: "1", img: img('lannister','tactics','1.png') },
                        { name: "2", img: img('lannister','tactics','2.png') },
                        { name: "3", img: img('lannister','tactics','3.png') },
                        { name: "4", img: img('lannister','tactics','4.png') },
                        { name: "5", img: img('lannister','tactics','5.png') },
                        { name: "6", img: img('lannister','tactics','6.png') },
                        { name: "7", img: img('lannister','tactics','7.png') }
                    ]
                };
            }
            // 12/2025 Decks
            return {
                "House Stark": [
                    { name: "The Cold Wind Blows", img: img('stark','tactics','cw.png') },
                    { name: "Northern Ferocity", img: img('stark','tactics','nf.png') },
                    { name: "Relentless Charge", img: img('stark','tactics','rc.png') }, 
                    { name: "Winter Is Coming", img: img('stark','tactics','wc.png') },
                    { name: "Swift Reposition", img: img('stark','tactics','sr.png') },
                    { name: "The Pack Survives", img: img('stark','tactics','ps.png') },
                    { name: "The North Endures", img: img('stark','tactics','ne.png') }
                ],
                "House Bolton": [
                    { name: "A Flayed Men Has No Secrets", img: img('bolton','tactics','fm.png') },
                    { name: "Our Blades Are Sharp", img: img('bolton','tactics','ob.png') },
                    { name: "Fear Keeps A Man Alive", img: img('bolton','tactics','fk.png') },
                    { name: "Sadistic Games", img: img('bolton','tactics','sg.png') },
                    { name: "Flay Them All!", img: img('bolton','tactics','ft.png') },
                    { name: "Horrific Reputation", img: img('bolton','tactics','hr.png') },
                    { name: "Cruelty And Cunning", img: img('bolton','tactics','cc.png') }
                ],
                "House Lannister": [
                    { name: "Hear Me Roar!", img: img('lannister','tactics','hmr.png') },
                    { name: "Counterplot", img: img('lannister','tactics','cp.png') },
                    { name: "Intrigue and Subterfuge", img: img('lannister','tactics','is.png') },
                    { name: "Wealth of the Rock", img: img('lannister','tactics','wr.png') },
                    { name: "Subjugation of Power", img: img('lannister','tactics','sub.png') },
                    { name: "A Lannister Pays His Debts", img: img('lannister','tactics','ld.png') },
                    { name: "Bribery", img: img('lannister','tactics','b.png') }
                ],
                "House Baratheon (Renly)": [
                    { name: "Ours Is the Fury!", img: img('baratheon','tactics','r_o.png') },
                    { name: "Commanding Presence", img: img('baratheon','tactics','r_cp.png') },
                    { name: "Bannered Resolve", img: img('baratheon','tactics','r_br.png') },
                    { name: "Strength In Unity", img: img('baratheon','tactics','r_su.png') },
                    { name: "Rally The Banners", img: img('baratheon','tactics','r_rb.png') },
                    { name: "Pressured Onslaught", img: img('baratheon','tactics','r_po.png') },
                    { name: "The King's Favor", img: img('baratheon','tactics','r_kf.png') }
                ],
                "House Baratheon (Stannis)": [
                    { name: "Ours Is the Fury!", img: img('baratheon','tactics','s_o.png') },
                    { name: "Measured Retribution", img: img('baratheon','tactics','s_mr.png') },
                    { name: "Unrelenting Determination", img: img('baratheon','tactics','s_ud.png') },
                    { name: "Judgement Returned", img: img('baratheon','tactics','s_jr.png') },
                    { name: "By Patience And Will", img: img('baratheon','tactics','s_pw.png') },
                    { name: "Steadfast Pursuit", img: img('baratheon','tactics','s_sp.png') },
                    { name: "The King's Justice", img: img('baratheon','tactics','s_kj.png') }
                ]
            };
        }

        function getCommanderDecks(version) {
             // 12/2025 Decks
             let decks = {
                "Robb Stark (C)": [
                    { name: "Waiting To Strike", img: img('stark','tactics','ws.png') }, 
                    { name: "Hit And Run", img: img('stark','tactics','hr.png') },
                    { name: "Encircle The Prey", img: img('stark','tactics','ep.png') }
                ],
                "Greatjon Umber (C)": [
                    { name: "Berserker Tactics", img: img('stark','tactics','bt.png') },
                    { name: "Death Before Chains!", img: img('stark','tactics','dc.png') },
                    { name: "Most Fearless In The North", img: img('stark','tactics','mf.png') }
                ],
                "Brynden Tully (C)": [
                    { name: "Blackfish's Defiance", img: img('stark','tactics','bd.png') },
                    { name: "Family, Duty, Honor", img: img('stark','tactics','fdh.png') },
                    { name: "Tully Resolve", img: img('stark','tactics','tr.png') }
                ],
                "Howland Reed (C)": [
                    { name: "Lay Of The Land", img: img('stark','tactics','ll.png') }, 
                    { name: "Crannog Ambush", img: img('stark','tactics','ca.png') },
                    { name: "Bog Devil Tactics", img: img('stark','tactics','bdt.png') }
                ],
                "Roose Bolton (C)": [
                    { name: "Whispered Threats", img: img('bolton','tactics','wt.png') },
                    { name: "Cold Regards", img: img('bolton','tactics','cr.png') },
                    { name: "Dreadfort Secrets", img: img('bolton','tactics','ds.png') }
                ],
                "Ramsay Snow (C)": [
                    { name: "Echoes Of Agony", img: img('bolton','tactics','ea.png') },
                    { name: "Broken Playthings", img: img('bolton','tactics','bp.png') },
                    { name: "Spoil In Flesh", img: img('bolton','tactics','sf.png') }
                ],
                "Vargo Hoat (C)": [
                    { name: "The Crippler's Infamy", img: img('bolton','tactics','ci.png') },
                    { name: "Butcher's Work", img: img('bolton','tactics','bw.png') },
                    { name: "Savored Suffering", img: img('bolton','tactics','ss.png') }
                ],
                "Steelshanks Walton (C)": [
                    { name: "Steelshanks's Watch", img: img('bolton','tactics','sw.png') },
                    { name: "Fear Is Loyalty", img: img('bolton','tactics','fl.png') },
                    { name: "Disciplined Execution", img: img('bolton','tactics','de.png') }
                ],
                "Jaime Lannister (C)": [
                    { name: "Kingslayer's Pride", img: img('lannister','tactics','kp.png') },
                    { name: "Duelist's Patience", img: img('lannister','tactics','dp.png') },
                    { name: "Reckless Glory", img: img('lannister','tactics','rg.png') } 
                ],
                "Gregor Clegane (C)": [
                    { name: "Brutal Slayings", img: img('lannister','tactics','bs.png') },
                    { name: "Path of Destruction", img: img('lannister','tactics','pd.png') },
                    { name: "Fury Unleashed", img: img('lannister','tactics','fu.png') }
                ],
                "Tyrion Lannister (C)": [
                    { name: "Turn the Tables", img: img('lannister','tactics','tt.png') },
                    { name: "False Agenda", img: img('lannister','tactics','fa.png') },
                    { name: "Intercept Orders", img: img('lannister','tactics','io.png') }
                ],
                "Stannis Baratheon (C) - The Rightful Heir": [
                    { name: "Oath of Duty", img: img('baratheon','tactics','s_od.png') },
                    { name: "Judgement Rendered", img: img('baratheon','tactics','s_ju.png') },
                    { name: "To The Bitter End", img: img('baratheon','tactics','s_be.png') }
                ],
                "Renly Baratheon (C) - The Charismatic Heir": [
                    { name: "Younger, Bolder...", img: img('baratheon','tactics','r_yb.png') },
                    { name: "Unified Advance", img: img('baratheon','tactics','r_ua.png') },
                    { name: "The Realm Stands With Me!", img: img('baratheon','tactics','r_rs.png') }
                ]
            };

            if (version === "01/2026") {
                // OVERRIDES FOR 01/2026
                decks["Gregor Clegane (C)"] = [
                    { name: "1", img: img('lannister','tactics','g1.png') },
                    { name: "2", img: img('lannister','tactics','g2.png') },
                    { name: "3", img: img('lannister','tactics','g3.png') }
                ];
                decks["Jaime Lannister (C)"] = [
                    { name: "1", img: img('lannister','tactics','j1.png') },
                    { name: "2", img: img('lannister','tactics','j2.png') },
                    { name: "3", img: img('lannister','tactics','j3.png') }
                ];
                decks["Greatjon Umber (C)"] = [
                    { name: "1", img: img('stark','tactics','g1.png') },
                    { name: "2", img: img('stark','tactics','g2.png') },
                    { name: "3", img: img('stark','tactics','g3.png') }
                ];
                decks["Robb Stark (C)"] = [
                    { name: "1", img: img('stark','tactics','r1.png') },
                    { name: "2", img: img('stark','tactics','r2.png') },
                    { name: "3", img: img('stark','tactics','r3.png') }
                ];
            }
            return decks;
        }

        function getTerrainCards(version) {
            if(version === "01/2026") {
                return [
                    { name: "Bog", img: "https://i.imgur.com/TYVyCPY.jpeg", fullImg: "https://i.imgur.com/Cu57e3N.jpeg" },
                    { name: "Corpse Pile", img: "https://i.imgur.com/Xkk9qIP.jpeg", fullImg: "https://i.imgur.com/RDZAOhj.jpeg" },
                    { name: "Forest", img: "https://i.imgur.com/OgTlr0R.jpeg", fullImg: "https://i.imgur.com/SR56Dfe.jpeg" },
                    { name: "Hedge", img: "https://i.imgur.com/vh9dDcM.jpeg", fullImg: "https://i.imgur.com/dhT8qw8.jpeg" },
                    { name: "Low Wall", img: "https://i.imgur.com/RwLNe8H.jpeg", fullImg: "https://i.imgur.com/YisbVw3.jpeg" },
                    { name: "Stakes", img: "https://i.imgur.com/El5HQG5.jpeg", fullImg: "https://i.imgur.com/PHzySXY.jpeg" },
                    { name: "Weirdwood", img: "https://i.imgur.com/3W3AkRw.jpeg", fullImg: "https://i.imgur.com/7FyzClx.jpeg" } // Corrected typo in user prompt "7FyzClx" from "7FyzClx" (assumed)
                ];
            }
            return [
                { name: "Battlefield Layouts", img: "https://i.imgur.com/fPjf9FT.jpeg", fullImg: "https://i.imgur.com/fPjf9FT.jpeg" },
                { name: "Bog", img: "https://i.imgur.com/TYVyCPY.jpeg", fullImg: "https://i.imgur.com/cFazngM.jpeg" },
                { name: "Forest", img: "https://i.imgur.com/OgTlr0R.jpeg", fullImg: "https://i.imgur.com/wUPCX5J.jpeg" },
                { name: "Corpse pile", img: "https://i.imgur.com/Xkk9qIP.jpeg", fullImg: "https://i.imgur.com/VJo344l.jpeg" },
                { name: "Weirdwood", img: "https://i.imgur.com/3W3AkRw.jpeg", fullImg: "https://i.imgur.com/moyTtQn.jpeg" },
                { name: "Hedge", img: "https://i.imgur.com/vh9dDcM.jpeg", fullImg: "https://i.imgur.com/hUu9QEn.jpeg" },
                { name: "Stakes", img: "https://i.imgur.com/El5HQG5.jpeg", fullImg: "https://i.imgur.com/MmB7QlF.jpeg" },
                { name: "Low wall", img: "https://i.imgur.com/RwLNe8H.jpeg", fullImg: "https://i.imgur.com/L0mCM9d.jpeg" },
                { name: "Palisade", img: "https://i.imgur.com/W6QzwLT.jpeg", fullImg: "https://i.imgur.com/S6u14Zn.jpeg" }
            ];
        }

        function getGameModeCards(version) {
            if(version === "01/2026") {
                 return [
                    { name: "A Game Of Thrones", img: "https://i.imgur.com/O4gNBmx.jpeg" },
                    { name: "A Clash Of Kings", img: "https://i.imgur.com/kjH5SwG.jpeg" }
                ];
            }
            return [
                { name: "A Game Of Thrones", img: "https://i.imgur.com/P1YVd62.jpeg" },
                { name: "A Clash Of Kings", img: "https://i.imgur.com/cM8C0oa.jpeg" },
                { name: "A Dance With Dragons", img: "https://i.imgur.com/32ZtFT8.jpeg" }
            ];
        }

        const factionZoneCards = [
            { name: "House Lannister Zone", img: gameImg('zone-house-lannister.jpg') },
            { name: "House Bolton Zone", img: gameImg('zone-house-bolton.jpg') },
            { name: "House Stark Zone", img: gameImg('zone-house-stark.jpg') },
            { name: "House Baratheon Zone", img: gameImg('zone-house-baratheon.jpg') }
        ];

        // --- STATE & LOGIC ---
        const MAX_MAIN = 40; const MAX_FREE = 3;
        let activeFaction = "House Stark"; let roster = []; let currentUnitIndex = null;
        let currentLightboxImages = []; let currentLightboxIndex = 0;
        let currentVersion = "12/2025"; // Default version

        renderStore(); updateUI();

        // HELPER TO RESOLVE IMAGE URL BASED ON VERSION
        function resolveImageUrl(relativePath) {
            // Handle absolute URLs (like Imgur)
            if (relativePath.startsWith('http')) return relativePath;

            const baseUrl = VERSION_CONFIG[currentVersion].baseUrl;
            return `${baseUrl}/${relativePath}`;
        }

        // VERSION SWITCHING LOGIC
        function changeVersion(version) {
            if (roster.length > 0) {
                if (!confirm("Changing version will clear your current roster. Continue?")) {
                    document.getElementById('versionSelect').value = currentVersion;
                    return;
                }
            }
            
            currentVersion = version;
            roster = []; // Clear roster
            
            // Check Features
            const config = VERSION_CONFIG[currentVersion];
            const btnZone = document.getElementById('btnFactionZone');
            if (config.features.includes('factionZone')) {
                btnZone.style.display = 'inline-block';
            } else {
                btnZone.style.display = 'none';
            }

            // Check Factions
            const tabs = {
                "House Stark": document.getElementById('tabStark'),
                "House Bolton": document.getElementById('tabBolton'),
                "House Lannister": document.getElementById('tabLannister'),
                "House Baratheon": document.getElementById('tabBaratheon')
            };

            // Reset tabs display
            for (let f in tabs) {
                tabs[f].style.display = 'none';
            }

            let firstValid = null;
            config.factions.forEach(f => {
                if (tabs[f]) {
                    tabs[f].style.display = 'inline-block';
                    if (!firstValid) firstValid = f;
                }
            });

            // If active faction is not in new version, switch
            if (!config.factions.includes(activeFaction)) {
                setFaction(firstValid || "House Stark");
            } else {
                // Just re-render store
                renderStore();
                updateUI();
            }
        }


        // Updated Lightbox Logic
        function openLightbox(src) {
            currentLightboxImages = []; 
            document.getElementById('lightbox-img').src = src; 
            document.getElementById('lb-prev').style.display = 'none';
            document.getElementById('lb-next').style.display = 'none';
            document.getElementById('lightbox').style.display = 'flex'; 
        }

        function openLightboxGallery(images, index) {
            currentLightboxImages = images;
            currentLightboxIndex = index;
            updateLightboxImage();
            document.getElementById('lb-prev').style.display = 'block';
            document.getElementById('lb-next').style.display = 'block';
            document.getElementById('lightbox').style.display = 'flex';
        }

        function changeLightboxImage(dir) {
            event.stopPropagation();
            currentLightboxIndex += dir;
            if (currentLightboxIndex < 0) currentLightboxIndex = currentLightboxImages.length - 1;
            if (currentLightboxIndex >= currentLightboxImages.length) currentLightboxIndex = 0;
            updateLightboxImage();
        }

        function updateLightboxImage() {
            if(currentLightboxImages.length > 0) {
                document.getElementById('lightbox-img').src = currentLightboxImages[currentLightboxIndex];
            }
        }

        // Keyboard Navigation
        document.addEventListener('keydown', function(event) {
            if (document.getElementById('lightbox').style.display === 'flex' && currentLightboxImages.length > 0) {
                if (event.key === "ArrowLeft") {
                    changeLightboxImage(-1);
                } else if (event.key === "ArrowRight") {
                    changeLightboxImage(1);
                } else if (event.key === "Escape") {
                    closeLightbox();
                }
            }
        });

        function closeLightbox() { document.getElementById('lightbox').style.display = 'none'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        
        function setFaction(f) {
            activeFaction = f;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            if(f === 'House Stark') document.querySelector('.stark-btn').classList.add('active');
            else if(f === 'House Bolton') document.querySelector('.bolton-btn').classList.add('active');
            else if(f === 'House Lannister') document.querySelector('.lannister-btn').classList.add('active');
            else document.querySelector('.baratheon-btn').classList.add('active');
            renderStore();
        }

        function isCommanderInRoster() { return roster.some(item => item.attachments.some(a => a.isCommander)); }
        function getCommanderName() {
            for(let item of roster) {
                const comm = item.attachments.find(a => a.isCommander);
                if(comm) return comm.name;
            }
            return null;
        }

        function getCharacterNamesInRoster() {
            let names = new Set();
            roster.forEach(item => {
                item.attachments.forEach(a => names.add(getBaseName(a.name)));
                if (item.unit.isUnique) {
                    names.add(getBaseName(item.unit.name));
                }
            });
            return names;
        }

        function getFactionLoyalty() {
            // Find any unit or attachment with a loyalty property
            for (let item of roster) {
                if (item.unit.loyalty) return item.unit.loyalty;
                for (let att of item.attachments) {
                    if (att.loyalty) return att.loyalty;
                }
            }
            return null; // Neutral
        }

        function calculateStats() {
            let uPts = 0; let aPts = 0;
            roster.forEach(item => { uPts += item.unit.cost; item.attachments.forEach(a => aPts += a.cost); });
            let freeUsed = Math.min(aPts, MAX_FREE);
            let attSpill = aPts - freeUsed;
            return { mainUsed: uPts + attSpill, freeUsed, totalUnit: uPts, totalAtt: aPts };
        }

        function checkUnitAvailability(unit) {
            if (!checkAffordability(unit.cost, 'UNIT')) return false;
            if (unit.req) {
                const presentChars = getCharacterNamesInRoster();
                if (!presentChars.has(unit.req)) return false;
            }
            if (unit.isUnique) {
                const usedChars = getCharacterNamesInRoster();
                const baseName = getBaseName(unit.name);
                if (usedChars.has(baseName)) return false;
            }
            // Check Loyalty
            const currentLoyalty = getFactionLoyalty();
            if (currentLoyalty && unit.loyalty && unit.loyalty !== currentLoyalty) return false;

            return true;
        }

        function checkAffordability(cost, type) {
            const stats = calculateStats();
            if(type === 'UNIT' || type === 'COMBAT' || type === 'NCU') {
                return (stats.mainUsed + cost) <= MAX_MAIN;
            } else {
                let newAttTotal = stats.totalAtt + cost;
                let newFreeUsed = Math.min(newAttTotal, MAX_FREE);
                let newSpill = newAttTotal - newFreeUsed;
                return (stats.totalUnit + newSpill) <= MAX_MAIN;
            }
        }

        function renderStore() {
            const combatStore = document.getElementById('store-combat');
            const ncuStore = document.getElementById('store-ncu');
            combatStore.innerHTML = ''; ncuStore.innerHTML = '';
            
            unitsDB.filter(u => u.faction === activeFaction)
                   .filter(u => {
                       // VERSION FILTERING UNIT LOGIC
                       if (u.excludeVersions && u.excludeVersions.includes(currentVersion)) return false;
                       if (u.onlyVersions && !u.onlyVersions.includes(currentVersion)) return false;
                       return true;
                   })
                   .sort((a, b) => a.cost - b.cost)
                   .forEach(u => {
                const canAfford = checkUnitAvailability(u);
                const el = createCard(u, canAfford, () => addUnit(u));
                if(u.type === 'COMBAT') combatStore.appendChild(el); else ncuStore.appendChild(el);
            });
        }

        function createCard(data, active, onClick) {
            const div = document.createElement('div');
            div.className = `card ${!active ? 'disabled' : ''}`;
            let badge = data.isCommander ? `<div class="commander-badge">COMMANDER</div>` : '';
            let loyaltyBadge = '';
            if (data.loyalty === 'Stannis') loyaltyBadge = `<div class="loyalty-badge loyalty-stannis">STANNIS LOYALTY</div>`;
            if (data.loyalty === 'Renly') loyaltyBadge = `<div class="loyalty-badge loyalty-renly">RENLY LOYALTY</div>`;
            
            let specialBtn = '';
            if (data.special) {
                specialBtn = `<button class="btn-special" onclick="event.stopPropagation(); openLightbox('${data.special.img}')">Special</button>`;
            }

            const imageUrl = resolveImageUrl(data.img);

            div.innerHTML = `${badge}${loyaltyBadge}<div class="card-img-wrap" onclick="event.stopPropagation(); openLightbox('${imageUrl}')"><img src="${imageUrl}" onerror="this.src='https://via.placeholder.com/150'"></div><div class="card-info" onclick="${active?'addUnitByID('+data.id+')':''}"><div class="card-name">${data.name}</div>${specialBtn}<div class="card-cost">${data.cost} pts</div></div>`;
            div.querySelector('.card-info').onclick = active ? onClick : null;
            return div;
        }

        function addUnit(unit) { roster.push({ unit: {...unit}, attachments: [] }); updateUI(); }
        function removeUnit(idx) { roster.splice(idx, 1); updateUI(); }
        
        function openAttModal(idx) {
            currentUnitIndex = idx;
            const modalGrid = document.getElementById('att-store-grid'); modalGrid.innerHTML = '';
            const hasComm = isCommanderInRoster();
            const usedChars = getCharacterNamesInRoster();
            const targetUnit = roster[idx].unit;
            const targetUnitType = targetUnit.unitType || 'Infantry';
            const unitAtts = roster[idx].attachments;
            const currentLoyalty = getFactionLoyalty(); // Get Loyalty

            const atts = attachmentsDB.filter(a => a.faction === targetUnit.faction)
                .filter(a => {
                   // VERSION FILTERING ATT LOGIC
                   if (a.excludeVersions && a.excludeVersions.includes(currentVersion)) return false;
                   if (a.onlyVersions && !a.onlyVersions.includes(currentVersion)) return false;
                   return true;
                });

            atts.sort((a, b) => (a.isCommander === b.isCommander) ? 0 : a.isCommander ? -1 : 1);
            document.getElementById('commander-msg').style.display = hasComm ? 'block' : 'none';
            atts.forEach(a => {
                let canAfford = checkAffordability(a.cost, 'ATTACHMENT');
                let baseName = getBaseName(a.name);
                let attType = a.unitType || 'Infantry';
                let slotType = a.attType || 1;
                if(a.isCommander && hasComm) canAfford = false;
                if(a.isUnique && usedChars.has(baseName)) canAfford = false;
                if(attType !== targetUnitType) canAfford = false;
                if(slotType === 1 && unitAtts.some(x => x.attType === 1)) canAfford = false;
                if(slotType === 3 && unitAtts.some(x => x.attType === 3)) canAfford = false;
                if(slotType === 4 && a.req) {
                    if(!unitAtts.some(x => getBaseName(x.name) === a.req)) canAfford = false;
                }
                // Check Loyalty for Attachments
                if (currentLoyalty && a.loyalty && a.loyalty !== currentLoyalty) canAfford = false;

                modalGrid.appendChild(createCard(a, canAfford, () => addAttachment(a)));
            });
            document.getElementById('attModal').style.display = 'flex';
        }

        function addAttachment(att) { if(currentUnitIndex!==null) { roster[currentUnitIndex].attachments.push({...att}); closeModal('attModal'); updateUI(); } }
        function removeAttachment(uIdx, aIdx) { roster[uIdx].attachments.splice(aIdx, 1); updateUI(); }
        function resetAll() { if(confirm('Are you sure you want to reset the list?')) { roster = []; updateUI(); } }

        function renderDeck(deckName) {
            const fGrid = document.getElementById('faction-tactics-grid');
            fGrid.innerHTML = '';
            
            const decks = getFactionDecks(currentVersion);
            const deck = decks[deckName];
            
            if(deck) {
               deck.forEach((c, i) => fGrid.appendChild(createTacticCard(c, i, deck)));
            }
        }

        function openTacticsModal() {
            const fGrid = document.getElementById('faction-tactics-grid');
            const cGrid = document.getElementById('commander-tactics-grid');
            const cTitle = document.getElementById('commander-tactics-title');
            const msg = document.getElementById('no-commander-msg');
            const baraChoice = document.getElementById('baratheon-choice');
            
            fGrid.innerHTML = '';
            baraChoice.style.display = 'none';
            
            const decks = getFactionDecks(currentVersion);

            // Special logic for Baratheon
            if (activeFaction === 'House Baratheon') {
                const loyalty = getFactionLoyalty();
                if (loyalty === 'Stannis') {
                    renderDeck('House Baratheon (Stannis)');
                } else if (loyalty === 'Renly') {
                    renderDeck('House Baratheon (Renly)');
                } else {
                    // Neutral: Show choice buttons
                    baraChoice.style.display = 'block';
                }
            } else {
                // Standard Logic
                const deck = decks[activeFaction]||[];
                deck.forEach((c, i) => fGrid.appendChild(createTacticCard(c, i, deck)));
            }

            cGrid.innerHTML = '';
            const commName = getCommanderName();
            const commDecks = getCommanderDecks(currentVersion);

            if(commName && commDecks[commName]) {
                cTitle.style.display = 'block'; cGrid.style.display = 'grid'; msg.style.display = 'none';
                cTitle.innerText = `Commander Cards : ${commName}`;
                const commDeck = commDecks[commName];
                commDeck.forEach((c, i) => cGrid.appendChild(createTacticCard(c, i, commDeck)));
            } else {
                cTitle.style.display = 'none'; cGrid.style.display = 'none'; msg.style.display = 'block';
                msg.innerText = commName ? `No cards defined for ${commName}` : "No Commander selected.";
            }
            document.getElementById('tacticsModal').style.display = 'flex';
        }

        function openFactionZoneModal() {
            const grid = document.getElementById('faction-zone-grid');
            grid.innerHTML = '';
            factionZoneCards.forEach((c, i) => {
                grid.appendChild(createTacticCard(c, i, factionZoneCards));
            });
            document.getElementById('factionZoneModal').style.display = 'flex';
        }

        function openTerrainModal() {
            const grid = document.getElementById('terrain-grid');
            const special = document.getElementById('terrain-special');
            grid.innerHTML = '';
            special.innerHTML = '';
            
            const cards = getTerrainCards(currentVersion);

            const layoutCard = cards.find(c => c.name === "Battlefield Layouts");
            // NOTE: We don't enable gallery nav for single special card usually, but we can pass a single item array if needed.
            // For now, standard click for layout
            if(layoutCard) {
                const div = document.createElement('div');
                div.className = 'tactic-card';
                div.innerHTML = `<img src="${layoutCard.img}" alt="${layoutCard.name}">`;
                div.onclick = () => openLightbox(layoutCard.fullImg || layoutCard.img);
                special.appendChild(div);
            }

            const standardTerrain = cards.filter(c => c.name !== "Battlefield Layouts");
            standardTerrain.forEach((c, i) => {
                grid.appendChild(createTacticCard(c, i, standardTerrain));
            });
            
            document.getElementById('terrainModal').style.display = 'flex';
        }

        function openGameModeModal() {
            const grid = document.getElementById('gamemode-grid');
            grid.innerHTML = '';
            
            grid.style.display = 'flex';
            grid.style.flexDirection = 'column';
            grid.style.gap = '15px';
            
            const cards = getGameModeCards(currentVersion);

            cards.forEach((c, i) => {
                const btn = document.createElement('button');
                btn.className = 'btn-action btn-gamemode'; 
                btn.style.width = '100%';
                btn.style.padding = '15px';
                btn.style.fontSize = '1.2rem';
                btn.style.cursor = 'pointer';
                btn.innerText = c.name;
                // Pass gameModeCards as gallery
                const images = cards.map(gm => gm.img);
                btn.onclick = () => openLightboxGallery(images, i);
                
                grid.appendChild(btn);
            });

            document.getElementById('gameModeModal').style.display = 'flex';
        }

        function openFeedbackModal() {
            document.getElementById('feedbackModal').style.display = 'flex';
        }

        async function copyEmail() {
            const email = "songtesting@cmon.com";
            try {
                await navigator.clipboard.writeText(email);
                const btn = document.querySelector('#feedbackModal .btn-feedback'); 
                const originalText = btn.innerText;
                btn.innerText = "Copied!";
                btn.style.backgroundColor = "#27ae60"; 
                setTimeout(() => {
                    btn.innerText = originalText;
                    btn.style.backgroundColor = ""; 
                }, 2000);
            } catch (e) {
                alert("Erreur lors de la copie");
            }
        }

        // Updated Function: Accepts Index and Array for Gallery Navigation
        function createTacticCard(card, index, allCards) {
            const div = document.createElement('div');
            div.className = 'tactic-card';
            
            const imageUrl = resolveImageUrl(card.img);
            div.innerHTML = `<img src="${imageUrl}" alt="${card.name}">`;
            
            // Build simple array of images for the gallery with resolved URLs
            const galleryImages = allCards.map(c => resolveImageUrl(c.fullImg || c.img));
            
            div.onclick = () => openLightboxGallery(galleryImages, index);
            return div;
        }

        function updateUI() {
            const stats = calculateStats();
            const hasComm = isCommanderInRoster();
            document.getElementById('mainPts').innerText = stats.mainUsed;
            document.getElementById('freePts').innerText = stats.freeUsed;
            document.getElementById('unitPts').innerText = stats.totalUnit;
            document.getElementById('attPts').innerText = stats.totalAtt;
            const commInd = document.getElementById('commanderIndicator');
            commInd.innerText = hasComm ? "Commander OK" : "Commander Required";
            commInd.className = hasComm ? "commander-status status-ok" : "commander-status status-missing";
            renderStore();
            const lC = document.getElementById('roster-list-combat'); lC.innerHTML = '';
            const lN = document.getElementById('roster-list-ncu'); lN.innerHTML = '';
            roster.forEach((item, idx) => {
                const el = document.createElement('div'); el.className = 'roster-unit';
                let attHTML = '';
                if(item.unit.type === 'COMBAT') {
                    item.attachments.forEach((a, aIdx) => {
                        const sComm = a.isCommander ? 'is-commander' : '';
                        const nComm = a.isCommander ? 'ðŸ‘‘ ' : '+ ';
                        const attImgUrl = resolveImageUrl(a.img);
                        attHTML += `<div class="att-row ${sComm}"><span class="att-name-link" onclick="openLightbox('${attImgUrl}')">${nComm}${a.name}</span><div style="display:flex; gap:10px;"><b>${a.cost} pts</b><span style="color:#e74c3c; cursor:pointer;" onclick="removeAttachment(${idx}, ${aIdx})">X</span></div></div>`;
                    });
                    attHTML += `<button class="btn-add" onclick="openAttModal(${idx})">+ Add Attachment</button>`;
                }
                
                // Bouton Special dans le roster
                let rosterSpecialBtn = '';
                if(item.unit.special) {
                    rosterSpecialBtn = `<button class="btn-special" style="margin-right:10px;" onclick="openLightbox('${item.unit.special.img}')">Special</button>`;
                }

                const unitImgUrl = resolveImageUrl(item.unit.img);

                el.innerHTML = `<div class="unit-header"><div style="display:flex; align-items:center; gap:10px;"><img src="${unitImgUrl}" class="unit-thumb" onclick="openLightbox('${unitImgUrl}')"><div><div style="display:flex; align-items:center; gap:5px;"><b>${item.unit.name}</b> ${rosterSpecialBtn}</div><div style="color:var(--text-muted); font-size:0.8rem;">${item.unit.cost} pts</div></div></div><button onclick="removeUnit(${idx})" style="border:none; background:none; color:var(--text-muted); font-size:1.2rem; cursor:pointer;" onmouseover="this.style.color='#e74c3c'" onmouseout="this.style.color='var(--text-muted)'">&times;</button></div>${attHTML}`;
                if(item.unit.type === 'COMBAT') lC.appendChild(el); else lN.appendChild(el);
            });
        }

        async function shareList() {
            const stats = calculateStats();
            const commander = getCommanderName() || "None";
            const loyalty = getFactionLoyalty() || "Neutral";
            const cU = roster.filter(i => i.unit.type === 'COMBAT');
            const nU = roster.filter(i => i.unit.type === 'NCU');
            let t = `Faction: ${activeFaction}`;
            if(activeFaction === 'House Baratheon') t += ` (${loyalty})`;
            t += `\nCommander: ${commander}\nPoints: ${stats.mainUsed}/40 (Free Att: ${stats.freeUsed}/3)\n\n`;
            
            if(cU.length) { t += `Battlefield Units\n`; cU.forEach(i => { t += ` â€¢ ${i.unit.name} (${i.unit.cost})\n`; i.attachments.forEach(a => t += `     ${a.name} (${a.cost})\n`); }); t += `\n`; }
            if(nU.length) { t += `Council Units\n`; nU.forEach(i => t += ` â€¢ ${i.unit.name} (${i.unit.cost})\n`); }
            try { await navigator.clipboard.writeText(t); const b = document.querySelector('.btn-share'); const p = b.innerText; b.innerText = "Copied!"; setTimeout(() => b.innerText = p, 2000); } catch (e) { alert("Error copying list"); }
        }

        window.onclick = (e) => {
            if(e.target == document.getElementById('attModal')) closeModal('attModal');
            if(e.target == document.getElementById('tacticsModal')) closeModal('tacticsModal');
            if(e.target == document.getElementById('terrainModal')) closeModal('terrainModal');
            if(e.target == document.getElementById('gameModeModal')) closeModal('gameModeModal');
            if(e.target == document.getElementById('feedbackModal')) closeModal('feedbackModal');
            if(e.target == document.getElementById('factionZoneModal')) closeModal('factionZoneModal');
        }
    </script>
</body>
</html>